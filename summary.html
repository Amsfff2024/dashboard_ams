<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Issue Tracking Dashboard</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- PapaParse untuk parsing CSV -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --font-plus-jakarta: 'Plus Jakarta Sans', sans-serif;
            --font-inter: 'Inter', sans-serif;
            --critical-red: #dc3545;
            --warning-orange: #fd7e14;
            --normal-green: #28a745;
            --info-blue: #17a2b8;
            --vip-gold: #ffc107;
        }
        
        body {
            background: #f8fafc;
            font-family: var(--font-inter);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* HEADER */
        .executive-header {
            background: linear-gradient(135deg, #1a2980, #26d0ce);
            color: white;
            padding: 16px 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .executive-header h1 {
            font-family: var(--font-plus-jakarta);
            font-weight: 700;
            font-size: 1.5rem !important;
            margin: 0;
        }
        
        .executive-header p {
            font-family: var(--font-inter);
            font-weight: 400;
            font-size: 14px;
            opacity: 0.9;
        }
        
        /* KPI CARDS */
        .kpi-card {
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,.08);
            transition: all 0.3s ease;
            border: none;
            overflow: hidden;
            height: 100%;
        }
        
        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,.15);
        }
        
        .kpi-value {
            font-family: var(--font-plus-jakarta);
            font-weight: 800;
            font-size: 1.75rem;
            color: #1e293b;
        }
        
        .card-title {
            font-family: var(--font-plus-jakarta);
            font-weight: 600;
            font-size: 14px;
            color: #4b5563;
        }
        
        /* FILTER CARDS */
        .filter-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            border: none;
        }
        
        /* BUTTONS */
        .btn {
            font-family: var(--font-plus-jakarta);
            font-weight: 600;
            font-size: 14px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border: none;
            border-radius: 10px;
            padding: 10px;
        }
        
        .btn-outline-success {
            border-radius: 10px;
            padding: 10px 20px;
        }
        
        /* TABLE STYLING */
        .table thead th {
            font-family: var(--font-plus-jakarta);
            font-weight: 600;
            font-size: 12px;
            background: linear-gradient(135deg, #1e293b, #334155);
            color: #fff;
            position: sticky;
            top: 0;
            z-index: 10;
            border: none;
            padding: 8px 6px;
        }
        
        .table tbody td {
            font-family: var(--font-inter);
            font-weight: 400;
            font-size: 11px;
            padding: 6px 4px;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: middle;
        }
        
        /* BADGES */
        .badge {
            font-family: var(--font-plus-jakarta);
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
        }
        
        .badge-priority-P1 {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            border: none;
        }
        
        .badge-priority-P2 {
            background: linear-gradient(135deg, #fd7e14, #e8590c);
            color: white;
            border: none;
        }
        
        .badge-status-Open {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }
        
        .badge-status-Closed {
            background: linear-gradient(135deg, #28a745, #1e7e34);
            color: white;
        }
        
        /* AGING BADGES */
        .badge-aging-high {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }
        
        .badge-aging-medium {
            background: linear-gradient(135deg, #fd7e14, #e8590c);
            color: white;
        }
        
        .badge-aging-low {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
        }
        
        /* CHARTS CONTAINER */
        .chart-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            padding: 1rem;
            height: 100%;
        }
        
        /* MAIN TABLE CONTAINER */
        .main-table-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            border: none;
            overflow: hidden;
            flex: 1;
            height: 600px;
            display: flex;
            flex-direction: column;
        }
        
        .main-table-wrapper {
            overflow: auto;
            flex: 1;
        }
        
        /* SITE ID CELL */
        .site-id-cell {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
            font-weight: 600;
            color: #1e40af;
            font-size: 11px;
        }
        
        /* LOADING */
        #loadingSpinner {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 60px;
            font-size: 18px;
            color: #64748b;
            font-family: var(--font-inter);
        }
        
        /* SEARCH HIGHLIGHT */
        .search-highlight {
            background-color: #fff3cd;
            font-weight: 600;
        }
        
        /* PROGRESS BARS */
        .progress {
            height: 6px;
            border-radius: 4px;
        }
        
        /* RESPONSIVE */
        @media (max-width: 768px) {
            .executive-header {
                padding: 12px 16px;
                text-align: center;
            }
            
            .executive-header h1 {
                font-size: 1.2rem !important;
            }
            
            .kpi-value {
                font-size: 1.5rem;
            }
        }
        
        /* CUSTOM SCROLLBAR */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* FORM CONTROLS */
        .form-control, .form-select {
            font-family: var(--font-inter);
            font-size: 12px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        /* INFO BADGES */
        .info-badge {
            font-family: var(--font-inter);
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 10px;
            background: #e2e8f0;
            color: #475569;
        }
        
        /* TRUNCATE TEXT */
        .text-truncate-cell {
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="executive-header">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="mb-1"><i class="fas fa-tasks me-2"></i>Issue Tracking Dashboard</h1>
                    <p class="small mb-0 opacity-75">Network Issues Monitoring & Management</p>
                </div>
                <div class="text-end">
                    <div class="small mb-1"><i class="fas fa-clock me-1"></i> <span id="currentTime">Loading...</span></div>
                    <span class="badge bg-danger" id="dashboardStatus">
                        <i class="fas fa-circle me-1"></i> Loading Data...
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container-fluid py-4">
        <!-- Search and Filter Row -->
        <div class="row mb-4">
            <div class="col-lg-12">
                <div class="card filter-card">
                    <div class="card-body">
                        <h6 class="card-title mb-3"><i class="fas fa-filter me-2"></i>Filters & Search</h6>
                        <div class="row g-3">
                            <div class="col-md-3">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-id-badge"></i></span>
                                    <input type="text" class="form-control" id="searchSiteId" placeholder="Site ID" onkeyup="applyFilters()">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-exclamation-circle"></i></span>
                                    <select class="form-select" id="filterStatus" onchange="applyFilters()">
                                        <option value="">All Status</option>
                                        <option value="Open">Open</option>
                                        <option value="Closed">Closed</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-flag"></i></span>
                                    <select class="form-select" id="filterPriority" onchange="applyFilters()">
                                        <option value="">All Priority</option>
                                        <option value="P1">P1</option>
                                        <option value="P2">P2</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                                    <select class="form-select" id="filterCircle" onchange="applyFilters()">
                                        <option value="">All Circle</option>
                                        <!-- Options will be populated dynamically -->
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-8">
                                <small class="text-muted" id="searchResultsText">Total issues: <span id="totalIssuesCount">0</span> | Showing: <span id="filteredIssuesCount">0</span></small>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                                    <i class="fas fa-eraser me-1"></i> Clear All Filters
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- KPI Summary Row -->
        <div class="row mb-4">
            <div class="col-xl-2 col-lg-4 col-md-6 mb-3">
                <div class="card kpi-card p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title">TOTAL ISSUES</h6>
                            <div class="kpi-value text-primary" id="kpiTotalIssues">0</div>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-tasks fa-2x text-primary opacity-50"></i>
                        </div>
                    </div>
                    <div class="small text-muted mt-2">All reported issues</div>
                </div>
            </div>
            <div class="col-xl-2 col-lg-4 col-md-6 mb-3">
                <div class="card kpi-card p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title">OPEN ISSUES</h6>
                            <div class="kpi-value text-danger" id="kpiOpenIssues">0</div>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-exclamation-circle fa-2x text-danger opacity-50"></i>
                        </div>
                    </div>
                    <div class="small text-muted mt-2">Issues pending resolution</div>
                </div>
            </div>
            <div class="col-xl-2 col-lg-4 col-md-6 mb-3">
                <div class="card kpi-card p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title">HIGH PRIORITY</h6>
                            <div class="kpi-value text-warning" id="kpiHighPriority">0</div>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-flag fa-2x text-warning opacity-50"></i>
                        </div>
                    </div>
                    <div class="small text-muted mt-2">P1 Priority issues</div>
                </div>
            </div>
            <div class="col-xl-2 col-lg-4 col-md-6 mb-3">
                <div class="card kpi-card p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title">AGING > 1 MONTH</h6>
                            <div class="kpi-value text-info" id="kpiAgingIssues">0</div>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-calendar-times fa-2x text-info opacity-50"></i>
                        </div>
                    </div>
                    <div class="small text-muted mt-2">Issues older than 30 days</div>
                </div>
            </div>
            <div class="col-xl-2 col-lg-4 col-md-6 mb-3">
                <div class="card kpi-card p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title">AVG AGING</h6>
                            <div class="kpi-value text-secondary" id="kpiAvgAging">0</div>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-clock fa-2x text-secondary opacity-50"></i>
                        </div>
                    </div>
                    <div class="small text-muted mt-2">Average age in days</div>
                </div>
            </div>
            <div class="col-xl-2 col-lg-4 col-md-6 mb-3">
                <div class="card kpi-card p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title">UNIQUE SITES</h6>
                            <div class="kpi-value text-success" id="kpiUniqueSites">0</div>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-map-marker-alt fa-2x text-success opacity-50"></i>
                        </div>
                    </div>
                    <div class="small text-muted mt-2">Sites with issues</div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-lg-4 mb-4">
                <div class="chart-container">
                    <h6 class="mb-3"><i class="fas fa-chart-pie me-2"></i>Status Distribution</h6>
                    <div style="height: 250px;">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 mb-4">
                <div class="chart-container">
                    <h6 class="mb-3"><i class="fas fa-chart-bar me-2"></i>Priority Distribution</h6>
                    <div style="height: 250px;">
                        <canvas id="priorityChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 mb-4">
                <div class="chart-container">
                    <h6 class="mb-3"><i class="fas fa-chart-line me-2"></i>Top Problem Categories</h6>
                    <div style="height: 250px;">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Sites and Aging Analysis -->
        <div class="row mb-4">
            <div class="col-lg-6 mb-4">
                <div class="chart-container">
                    <h6 class="mb-3"><i class="fas fa-building me-2"></i>Top Sites with Issues</h6>
                    <div class="table-responsive" style="max-height: 300px;">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Site ID</th>
                                    <th class="text-end">Issues</th>
                                    <th class="text-end">Open</th>
                                    <th class="text-end">P1</th>
                                </tr>
                            </thead>
                            <tbody id="topSitesBody">
                                <tr><td colspan="4" class="text-center py-3">Loading data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-4">
                <div class="chart-container">
                    <h6 class="mb-3"><i class="fas fa-calendar-alt me-2"></i>Aging Analysis</h6>
                    <div class="table-responsive" style="max-height: 300px;">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Site ID</th>
                                    <th>Issue</th>
                                    <th class="text-end">Aging</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="agingIssuesBody">
                                <tr><td colspan="4" class="text-center py-3">Loading data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Issues Table -->
        <div class="row">
            <div class="col-12">
                <div class="main-table-container">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0" style="font-family: var(--font-plus-jakarta); font-weight: 700;">
                            <i class="fas fa-table me-2"></i>Detailed Issues
                        </h6>
                        <div>
                            <span class="info-badge me-2" id="tableCountBadge">Showing 0 issues</span>
                            <button class="btn btn-outline-success btn-sm" onclick="exportToCSV()">
                                <i class="fas fa-download me-1"></i> Export
                            </button>
                            <button class="btn btn-primary btn-sm ms-2" onclick="fetchCSVData()">
                                <i class="fas fa-redo me-1"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div class="main-table-wrapper">
                        <div id="loadingSpinner">
                            <div class="text-center">
                                <div class="spinner-border text-primary mb-3" role="status"></div>
                                <p style="font-family: var(--font-inter);">Loading issue data...</p>
                            </div>
                        </div>
                        <div class="table-responsive" id="issuesTableContainer" style="display: none;">
                            <table class="table table-striped table-hover table-sm">
                                <thead>
                                    <tr>
                                        <th class="cursor-pointer" onclick="sortTable('siteId')">
                                            Site ID <i class="fas fa-sort ms-1"></i>
                                        </th>
                                        <th class="cursor-pointer" onclick="sortTable('problemCategory')">
                                            Problem <i class="fas fa-sort ms-1"></i>
                                        </th>
                                        <th class="cursor-pointer" onclick="sortTable('priority')">
                                            Priority <i class="fas fa-sort ms-1"></i>
                                        </th>
                                        <th class="cursor-pointer" onclick="sortTable('status')">
                                            Status <i class="fas fa-sort ms-1"></i>
                                        </th>
                                        <th class="cursor-pointer" onclick="sortTable('aging')">
                                            Aging <i class="fas fa-sort ms-1"></i>
                                        </th>
                                        <th class="cursor-pointer" onclick="sortTable('pic')">
                                            PIC <i class="fas fa-sort ms-1"></i>
                                        </th>
                                        <th class="cursor-pointer" onclick="sortTable('rootCause')">
                                            Root Cause <i class="fas fa-sort ms-1"></i>
                                        </th>
                                        <th class="cursor-pointer" onclick="sortTable('action')">
                                            Action <i class="fas fa-sort ms-1"></i>
                                        </th>
                                        <th>Circle</th>
                                        <th>Vendor</th>
                                    </tr>
                                </thead>
                                <tbody id="detailedIssuesTableBody">
                                    <!-- Data akan diisi oleh JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="text-center small text-muted">
                    <p class="mb-1" style="font-family: var(--font-inter);">
                        <i class="fas fa-database me-1"></i> Data Source: Google Sheets | 
                        <i class="fas fa-clock me-1 ms-3"></i> Last Updated: <span id="lastUpdatedTime">-</span> |
                        <i class="fas fa-info-circle me-1 ms-3"></i> Total Records: <span id="totalRecords">0</span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // ==================== KONFIGURASI ====================
        const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSchfOZU-jK0FoiBjpyWsAezO2MdnPkJUh5bKRbs1sAI6DpJ0DocsMNBL_89QMjnnho1X9x_bKwEqjD/pub?gid=0&single=true&output=csv";

        // ==================== VARIABEL GLOBAL ====================
        let allIssueData = [];
        let filteredIssueData = [];
        let currentSort = { column: 'aging', direction: 'desc' };
        let statusChart, priorityChart, categoryChart;

        // ==================== FUNGSI INISIALISASI ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard initializing...');
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            fetchCSVData();
        });

        // ==================== FUNGSI DATA ====================
        function fetchCSVData() {
            console.log('Fetching CSV data from:', CSV_URL);
            showLoading(true);
            updateDashboardStatus('loading', 'Fetching data...');
            
            Papa.parse(CSV_URL, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    console.log('CSV parsing complete. Rows:', results.data.length);
                    
                    if (results.data && results.data.length > 0) {
                        processIssueData(results.data);
                        updateDashboardStatus('success', 'Data loaded successfully');
                    } else {
                        console.warn('No data found in CSV');
                        showError('No data found in the CSV file.');
                        updateDashboardStatus('error', 'No data found');
                    }
                    showLoading(false);
                    updateLastUpdatedTime();
                },
                error: function(error) {
                    console.error('Error fetching CSV:', error);
                    showError('Failed to load data from CSV. Please check the URL.');
                    updateDashboardStatus('error', 'Failed to load data');
                    showLoading(false);
                }
            });
        }

        function processIssueData(rawData) {
            allIssueData = [];
            const circles = new Set();
            
            rawData.forEach(row => {
                // Extract relevant data
                const siteId = row['SITE ID'] || '';
                const problemCategory = row['Problem Category'] || '';
                const priority = row['Priority'] || 'P2';
                const status = row['Status'] || 'Open';
                const aging = parseInt(row['Aging']) || 0;
                const pic = row['PIC'] || '';
                const rootCause = row['Root Cause Category'] || '';
                const action = row['Action Performed'] || '';
                const circle = row['Circle'] || '';
                const vendor = row['Vendor'] || '';
                const additionalInfo = row['Additional Info'] || '';
                const openDate = row['Open Date'] || '';
                const closedDate = row['Closed Date'] || '';
                const countOfIssue = parseInt(row['Count of Issue']) || 1;
                
                if (!siteId || !problemCategory) return;
                
                // Add circle to filter options
                if (circle) circles.add(circle);
                
                const processedRow = {
                    raw: row,
                    siteId: siteId,
                    problemCategory: problemCategory,
                    priority: priority,
                    status: status,
                    aging: aging,
                    pic: pic,
                    rootCause: rootCause,
                    action: action,
                    circle: circle,
                    vendor: vendor,
                    additionalInfo: additionalInfo,
                    openDate: openDate,
                    closedDate: closedDate,
                    countOfIssue: countOfIssue,
                    isHighAging: aging > 30
                };
                
                allIssueData.push(processedRow);
            });
            
            console.log(`Processed ${allIssueData.length} issue records`);
            console.log(`Unique circles: ${circles.size}`);
            
            // Update circle filter options
            updateCircleFilterOptions(Array.from(circles));
            
            applyFilters();
        }

        function updateCircleFilterOptions(circles) {
            const filterSelect = document.getElementById('filterCircle');
            filterSelect.innerHTML = '<option value="">All Circle</option>';
            
            circles.sort().forEach(circle => {
                const option = document.createElement('option');
                option.value = circle;
                option.textContent = circle;
                filterSelect.appendChild(option);
            });
        }

        // ==================== FUNGSI FILTER & PENCARIAN ====================
        function applyFilters() {
            const searchSiteId = document.getElementById('searchSiteId').value.toLowerCase().trim();
            const filterStatus = document.getElementById('filterStatus').value;
            const filterPriority = document.getElementById('filterPriority').value;
            const filterCircle = document.getElementById('filterCircle').value;
            
            filteredIssueData = allIssueData.filter(issue => {
                const siteIdMatch = !searchSiteId || 
                    issue.siteId.toLowerCase().includes(searchSiteId);
                
                const statusMatch = !filterStatus || 
                    issue.status === filterStatus;
                
                const priorityMatch = !filterPriority || 
                    issue.priority === filterPriority;
                
                const circleMatch = !filterCircle || 
                    issue.circle === filterCircle;
                
                return siteIdMatch && statusMatch && priorityMatch && circleMatch;
            });
            
            updateSummaryKPIs();
            updateCharts();
            updateTopSitesTable();
            updateAgingIssuesTable();
            updateDetailedIssuesTable();
        }

        function clearFilters() {
            document.getElementById('searchSiteId').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterPriority').value = '';
            document.getElementById('filterCircle').value = '';
            
            applyFilters();
        }

        // ==================== FUNGSI UPDATE UI ====================
        function updateSummaryKPIs() {
            const totalIssues = allIssueData.length;
            const openIssues = allIssueData.filter(issue => issue.status === 'Open').length;
            const highPriorityIssues = allIssueData.filter(issue => issue.priority === 'P1').length;
            const agingIssues = allIssueData.filter(issue => issue.aging > 30).length;
            
            // Calculate average aging for open issues
            const openAgingIssues = allIssueData.filter(issue => issue.status === 'Open');
            const avgAging = openAgingIssues.length > 0 
                ? Math.round(openAgingIssues.reduce((sum, issue) => sum + issue.aging, 0) / openAgingIssues.length)
                : 0;
            
            // Count unique sites
            const uniqueSites = new Set(allIssueData.map(issue => issue.siteId)).size;
            
            document.getElementById('kpiTotalIssues').textContent = totalIssues.toLocaleString();
            document.getElementById('kpiOpenIssues').textContent = openIssues.toLocaleString();
            document.getElementById('kpiHighPriority').textContent = highPriorityIssues.toLocaleString();
            document.getElementById('kpiAgingIssues').textContent = agingIssues.toLocaleString();
            document.getElementById('kpiAvgAging').textContent = avgAging + ' days';
            document.getElementById('kpiUniqueSites').textContent = uniqueSites.toLocaleString();
            
            // Update search results text
            document.getElementById('totalIssuesCount').textContent = allIssueData.length;
            document.getElementById('filteredIssuesCount').textContent = filteredIssueData.length;
            document.getElementById('searchResultsText').textContent = 
                `Total issues: ${allIssueData.length} | Showing: ${filteredIssueData.length}`;
            document.getElementById('totalRecords').textContent = allIssueData.length;
        }

        function updateCharts() {
            // Update Status Chart
            const statusCounts = {
                'Open': filteredIssueData.filter(issue => issue.status === 'Open').length,
                'Closed': filteredIssueData.filter(issue => issue.status === 'Closed').length
            };
            
            if (statusChart) statusChart.destroy();
            statusChart = new Chart(document.getElementById('statusChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Open', 'Closed'],
                    datasets: [{
                        data: [statusCounts.Open, statusCounts.Closed],
                        backgroundColor: ['#dc3545', '#28a745'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    family: 'Inter',
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
            
            // Update Priority Chart
            const priorityCounts = {
                'P1': filteredIssueData.filter(issue => issue.priority === 'P1').length,
                'P2': filteredIssueData.filter(issue => issue.priority === 'P2').length
            };
            
            if (priorityChart) priorityChart.destroy();
            priorityChart = new Chart(document.getElementById('priorityChart'), {
                type: 'bar',
                data: {
                    labels: ['P1', 'P2'],
                    datasets: [{
                        label: 'Issues',
                        data: [priorityCounts.P1, priorityCounts.P2],
                        backgroundColor: ['#fd7e14', '#6c757d'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    family: 'Inter',
                                    size: 10
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    family: 'Inter',
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
            
            // Update Category Chart (Top 5 problem categories)
            const categoryCounts = {};
            filteredIssueData.forEach(issue => {
                categoryCounts[issue.problemCategory] = (categoryCounts[issue.problemCategory] || 0) + 1;
            });
            
            const sortedCategories = Object.entries(categoryCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            if (categoryChart) categoryChart.destroy();
            categoryChart = new Chart(document.getElementById('categoryChart'), {
                type: 'horizontalBar',
                data: {
                    labels: sortedCategories.map(item => item[0]),
                    datasets: [{
                        label: 'Count',
                        data: sortedCategories.map(item => item[1]),
                        backgroundColor: '#3b82f6',
                        borderWidth: 0
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    family: 'Inter',
                                    size: 10
                                }
                            }
                        },
                        y: {
                            ticks: {
                                font: {
                                    family: 'Inter',
                                    size: 10
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateTopSitesTable() {
            const tbody = document.getElementById('topSitesBody');
            
            if (filteredIssueData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-3">No issues found</td></tr>';
                return;
            }
            
            // Group by site ID
            const siteStats = {};
            filteredIssueData.forEach(issue => {
                if (!siteStats[issue.siteId]) {
                    siteStats[issue.siteId] = {
                        siteId: issue.siteId,
                        total: 0,
                        open: 0,
                        p1: 0
                    };
                }
                
                siteStats[issue.siteId].total++;
                if (issue.status === 'Open') siteStats[issue.siteId].open++;
                if (issue.priority === 'P1') siteStats[issue.siteId].p1++;
            });
            
            // Convert to array and sort by total issues
            const sortedSites = Object.values(siteStats)
                .sort((a, b) => b.total - a.total)
                .slice(0, 10); // Top 10 sites
            
            tbody.innerHTML = '';
            
            sortedSites.forEach(site => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="site-id-cell">${site.siteId}</td>
                    <td class="text-end fw-semibold">${site.total}</td>
                    <td class="text-end">${site.open}</td>
                    <td class="text-end">${site.p1}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateAgingIssuesTable() {
            const tbody = document.getElementById('agingIssuesBody');
            
            if (filteredIssueData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-3">No issues found</td></tr>';
                return;
            }
            
            // Filter open issues and sort by aging (descending)
            const agingIssues = filteredIssueData
                .filter(issue => issue.status === 'Open')
                .sort((a, b) => b.aging - a.aging)
                .slice(0, 10); // Top 10 aging issues
            
            tbody.innerHTML = '';
            
            agingIssues.forEach(issue => {
                const agingBadgeClass = issue.aging > 60 ? 'badge-aging-high' : 
                                       issue.aging > 30 ? 'badge-aging-medium' : 'badge-aging-low';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="site-id-cell">${issue.siteId}</td>
                    <td class="text-truncate-cell" title="${issue.problemCategory}">${issue.problemCategory}</td>
                    <td class="text-end">
                        <span class="badge ${agingBadgeClass}">${issue.aging} days</span>
                    </td>
                    <td><span class="badge badge-status-${issue.status}">${issue.status}</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateDetailedIssuesTable() {
            const tbody = document.getElementById('detailedIssuesTableBody');
            const container = document.getElementById('issuesTableContainer');
            const countBadge = document.getElementById('tableCountBadge');
            
            if (filteredIssueData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="text-center py-5">
                            <i class="fas fa-search fa-2x text-muted mb-3"></i><br>
                            No issues found matching your criteria
                        </td>
                    </tr>
                `;
                countBadge.textContent = 'Showing 0 issues';
                container.style.display = 'block';
                return;
            }
            
            let sortedData = [...filteredIssueData];
            
            // Apply sorting
            sortedData.sort((a, b) => {
                const aVal = a[currentSort.column];
                const bVal = b[currentSort.column];
                
                if (currentSort.column === 'aging') {
                    return currentSort.direction === 'asc' ? aVal - bVal : bVal - aVal;
                }
                
                if (typeof aVal === 'string' && typeof bVal === 'string') {
                    return currentSort.direction === 'asc'
                        ? aVal.localeCompare(bVal)
                        : bVal.localeCompare(aVal);
                }
                
                return 0;
            });
            
            tbody.innerHTML = '';
            
            sortedData.forEach(issue => {
                const agingBadgeClass = issue.aging > 60 ? 'badge-aging-high' : 
                                       issue.aging > 30 ? 'badge-aging-medium' : 'badge-aging-low';
                
                // Truncate long text
                const truncatedAction = issue.action.length > 50 ? 
                    issue.action.substring(0, 47) + '...' : issue.action;
                
                const truncatedRootCause = issue.rootCause.length > 40 ? 
                    issue.rootCause.substring(0, 37) + '...' : issue.rootCause;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="site-id-cell">${issue.siteId}</td>
                    <td title="${issue.problemCategory}">${issue.problemCategory}</td>
                    <td><span class="badge badge-priority-${issue.priority}">${issue.priority}</span></td>
                    <td><span class="badge badge-status-${issue.status}">${issue.status}</span></td>
                    <td><span class="badge ${agingBadgeClass}">${issue.aging}d</span></td>
                    <td>${issue.pic}</td>
                    <td class="text-truncate-cell" title="${issue.rootCause}">${truncatedRootCause}</td>
                    <td class="text-truncate-cell" title="${issue.action}">${truncatedAction}</td>
                    <td>${issue.circle}</td>
                    <td>${issue.vendor}</td>
                `;
                tbody.appendChild(row);
            });
            
            countBadge.textContent = `Showing ${filteredIssueData.length.toLocaleString()} issues`;
            container.style.display = 'block';
        }

        function sortTable(column) {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'desc';
            }
            
            updateDetailedIssuesTable();
        }

        // ==================== FUNGSI UTILITAS ====================
        function exportToCSV() {
            if (filteredIssueData.length === 0) {
                alert('No data to export!');
                return;
            }
            
            const headers = ['SITE ID', 'Problem Category', 'Priority', 'Status', 'Aging', 'PIC', 
                           'Root Cause Category', 'Action Performed', 'Circle', 'Vendor', 'Open Date', 'Closed Date'];
            
            const csvData = [
                headers.join(','),
                ...filteredIssueData.map(issue => [
                    issue.siteId,
                    `"${issue.problemCategory.replace(/"/g, '""')}"`,
                    issue.priority,
                    issue.status,
                    issue.aging,
                    `"${issue.pic.replace(/"/g, '""')}"`,
                    `"${issue.rootCause.replace(/"/g, '""')}"`,
                    `"${issue.action.replace(/"/g, '""')}"`,
                    issue.circle,
                    issue.vendor,
                    issue.openDate,
                    issue.closedDate
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `issues_dashboard_${new Date().toISOString().slice(0,10)}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`Exported ${filteredIssueData.length} issues to CSV`);
        }

        function updateCurrentTime() {
            const now = new Date();
            const options = { 
                weekday: 'short', 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit',
                hour12: false
            };
            document.getElementById('currentTime').textContent = 
                now.toLocaleDateString('en-GB', options).replace(',', '');
        }

        function updateLastUpdatedTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-GB', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            document.getElementById('lastUpdatedTime').textContent = timeString;
        }

        function updateDashboardStatus(status, message) {
            const badge = document.getElementById('dashboardStatus');
            
            switch(status) {
                case 'loading':
                    badge.className = 'badge bg-warning';
                    badge.innerHTML = '<i class="fas fa-sync fa-spin me-1"></i> ' + message;
                    break;
                case 'success':
                    badge.className = 'badge bg-success';
                    badge.innerHTML = '<i class="fas fa-check-circle me-1"></i> ' + message;
                    break;
                case 'error':
                    badge.className = 'badge bg-danger';
                    badge.innerHTML = '<i class="fas fa-exclamation-circle me-1"></i> ' + message;
                    break;
            }
        }

        function showLoading(show) {
            const loadingDiv = document.getElementById('loadingSpinner');
            loadingDiv.style.display = show ? 'flex' : 'none';
        }

        function showError(message) {
            const tbody = document.getElementById('detailedIssuesTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="10" class="text-center py-5 text-danger">
                        <i class="fas fa-exclamation-triangle fa-2x mb-3"></i><br>
                        ${message}
                    </td>
                </tr>
            `;
            document.getElementById('issuesTableContainer').style.display = 'block';
        }
    </script>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
