<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FSO Dashboard - Regional Ranking</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- PapaParse untuk parsing CSV -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js Data Labels Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0/dist/chartjs-plugin-datalabels.min.js"></script>

    <style>
        :root {
            --font-plus-jakarta: 'Plus Jakarta Sans', sans-serif;
            --font-inter: 'Inter', sans-serif;
            --critical-red: #dc3545;
            --warning-orange: #fd7e14;
            --normal-green: #28a745;
            --info-blue: #17a2b8;
            --vip-gold: #ffc107;
            --fso-purple: #8b5cf6;
        }
        
        body {
            background: #f8fafc;
            font-family: var(--font-inter);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* HEADER */
        .executive-header {
            background: linear-gradient(135deg, #1a2980, #26d0ce);
            color: white;
            padding: 16px 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .executive-header h1 {
            font-family: var(--font-plus-jakarta);
            font-weight: 700;
            font-size: 1.5rem !important;
            margin: 0;
        }
        
        .executive-header p {
            font-family: var(--font-inter);
            font-weight: 400;
            font-size: 14px;
            opacity: 0.9;
        }
        
        /* TABS STYLING */
        .dashboard-tabs {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            padding: 0;
            margin-bottom: 24px;
            overflow: hidden;
        }
        
        .nav-tabs {
            border-bottom: 2px solid #e9ecef;
            padding: 0 20px;
            background: #f8fafc;
        }
        
        .nav-tabs .nav-link {
            font-family: var(--font-plus-jakarta);
            font-weight: 600;
            font-size: 14px;
            color: #64748b;
            border: none;
            padding: 16px 24px;
            margin-right: 8px;
            border-radius: 0;
            transition: all 0.2s ease;
        }
        
        .nav-tabs .nav-link:hover {
            color: #3b82f6;
            background: transparent;
            border-bottom: 3px solid #94a3b8;
        }
        
        .nav-tabs .nav-link.active {
            color: #3b82f6;
            background: transparent;
            border-bottom: 3px solid #3b82f6;
            font-weight: 700;
        }
        
        .nav-tabs .nav-link i {
            margin-right: 8px;
        }
        
        .tab-content {
            padding: 24px;
            background: white;
        }
        
        /* FILTER INDICATOR */
        .filter-indicator {
            background: linear-gradient(135deg, #8b5cf6, #6d28d9);
            color: white;
            border-radius: 8px;
            padding: 8px 16px;
            margin-bottom: 20px;
            display: inline-block;
            font-weight: 600;
        }
        
        .filter-indicator i {
            margin-right: 8px;
        }
        
        /* KPI CARDS */
        .kpi-card {
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,.08);
            transition: all 0.3s ease;
            border: none;
            overflow: hidden;
            height: 100%;
        }
        
        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,.15);
        }
        
        .kpi-value {
            font-family: var(--font-plus-jakarta);
            font-weight: 800;
            font-size: 1.75rem;
            color: #1e293b;
        }
        
        .card-title {
            font-family: var(--font-plus-jakarta);
            font-weight: 600;
            font-size: 14px;
            color: #4b5563;
        }
        
        /* FILTER CARDS */
        .filter-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            border: none;
        }
        
        /* BUTTONS */
        .btn {
            font-family: var(--font-plus-jakarta);
            font-weight: 600;
            font-size: 14px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border: none;
            border-radius: 10px;
            padding: 10px;
        }
        
        .btn-outline-success {
            border-radius: 10px;
            padding: 10px 20px;
        }
        
        /* TABLE STYLING */
        .table thead th {
            font-family: var(--font-plus-jakarta);
            font-weight: 600;
            font-size: 12px;
            background: linear-gradient(135deg, #1e293b, #334155);
            color: #fff;
            position: sticky;
            top: 0;
            z-index: 10;
            border: none;
            padding: 10px 8px;
            white-space: nowrap;
        }
        
        .table tbody td {
            font-family: var(--font-inter);
            font-weight: 400;
            font-size: 12px;
            padding: 8px 6px;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: middle;
        }
        
        /* MATRIX TABLE STYLING */
        .matrix-table-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            padding: 20px;
            margin-top: 20px;
            overflow-x: auto;
        }
        
        .matrix-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        .matrix-table th {
            background: linear-gradient(135deg, #1e293b, #334155);
            color: white;
            font-family: var(--font-plus-jakarta);
            font-weight: 600;
            font-size: 12px;
            padding: 12px 8px;
            text-align: center;
            border: 1px solid #334155;
        }
        
        .matrix-table th:first-child {
            text-align: left;
        }
        
        .matrix-table td {
            padding: 10px 8px;
            border: 1px solid #e2e8f0;
            text-align: center;
            font-family: var(--font-inter);
        }
        
        .matrix-table td:first-child {
            font-weight: 600;
            background-color: #f8fafc;
            text-align: left;
        }
        
        .matrix-table tbody tr:hover td {
            background-color: #f1f5f9;
        }
        
        .matrix-table tfoot {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            font-weight: 700;
        }
        
        .matrix-table tfoot td {
            font-weight: 700;
            background-color: #e2e8f0;
            border-top: 2px solid #94a3b8;
        }
        
        .total-column {
            background-color: #fef9c3;
            font-weight: 700;
        }
        
        /* BADGES */
        .badge {
            font-family: var(--font-plus-jakarta);
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
        }
        
        .badge-priority-P1 {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            border: none;
        }
        
        .badge-priority-P2 {
            background: linear-gradient(135deg, #fd7e14, #e8590c);
            color: white;
            border: none;
        }
        
        .badge-status-Open {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }
        
        .badge-status-Closed {
            background: linear-gradient(135deg, #28a745, #1e7e34);
            color: white;
        }
        
        /* AGING BADGES */
        .badge-aging-high {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }
        
        .badge-aging-medium {
            background: linear-gradient(135deg, #fd7e14, #e8590c);
            color: white;
        }
        
        .badge-aging-low {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
        }
        
        /* INFO BADGES */
        .info-badge {
            font-family: var(--font-inter);
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 10px;
            background: #e2e8f0;
            color: #475569;
        }
        
        /* STATS BADGE */
        .stats-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-weight: 600;
        }
        
        .stats-badge-primary { background: #dbeafe; color: #1d4ed8; }
        .stats-badge-success { background: #dcfce7; color: #166534; }
        .stats-badge-warning { background: #fef3c7; color: #92400e; }
        .stats-badge-danger { background: #fee2e2; color: #991b1b; }
        
        /* VENDOR LOGO */
        .vendor-logo {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            margin-right: 5px;
        }
        
        .vendor-nokia { background: #142c8e; color: white; }
        .vendor-huawei { background: #d4001a; color: white; }
        .vendor-other { background: #6b7280; color: white; }
        
        /* SITE ID CELL */
        .site-id-cell {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
            font-weight: 600;
            color: #1e40af;
            font-size: 11px;
        }
        
        /* LOADING */
        #loadingSpinner {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 60px;
            font-size: 18px;
            color: #64748b;
            font-family: var(--font-inter);
        }
        
        /* SEARCH RESULT INFO */
        .search-result-info {
            background: #f1f5f9;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid #3b82f6;
        }
        
        /* TRUNCATE TEXT */
        .text-truncate-cell {
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* AGING INDICATOR */
        .aging-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        
        .aging-critical { background-color: #dc3545; }
        .aging-warning { background-color: #fd7e14; }
        .aging-normal { background-color: #28a745; }
        
        /* TOOLTIP */
        .tooltip-cell {
            cursor: help;
            border-bottom: 1px dotted #666;
        }
        
        /* CUSTOM SCROLLBAR */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* RESPONSIVE */
        @media (max-width: 768px) {
            .executive-header {
                padding: 12px 16px;
                text-align: center;
            }
            
            .executive-header h1 {
                font-size: 1.2rem !important;
            }
            
            .kpi-value {
                font-size: 1.5rem;
            }
            
            .nav-tabs .nav-link {
                padding: 12px 16px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="executive-header">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="mb-1"><i class="fas fa-tasks me-2"></i>FSO Performance Dashboard</h1>
                    <p class="small mb-0 opacity-75">Regional Ranking by Area IOH & Issue Monitoring</p>
                </div>
                <div class="text-end">
                    <div class="small mb-1"><i class="fas fa-clock me-1"></i> <span id="currentTime">Loading...</span></div>
                    <span class="badge bg-danger" id="dashboardStatus">
                        <i class="fas fa-circle me-1"></i> Loading Data...
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container-fluid py-4">
        <!-- Filter Indicator -->
        <div class="filter-indicator">
            <i class="fas fa-filter"></i> Active Filter: <strong>PIC = FSO | Status = Open/New Open/Re-Open</strong>
            <span class="ms-3 badge bg-white text-dark" id="fsoCountBadge">Loading...</span>
        </div>
        
        <!-- Tabs Navigation -->
        <div class="dashboard-tabs">
            <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab" aria-controls="overview" aria-selected="true">
                        <i class="fas fa-chart-pie"></i> Overview Dashboard
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="regional-tab" data-bs-toggle="tab" data-bs-target="#regional" type="button" role="tab" aria-controls="regional" aria-selected="false">
                        <i class="fas fa-map-marked-alt"></i> Regional Ranking (by Area IOH)
                    </button>
                </li>
            </ul>
            
            <div class="tab-content" id="dashboardTabsContent">
                <!-- TAB 1: OVERVIEW DASHBOARD (FSO Dashboard) -->
                <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
                    <!-- Dashboard Title -->
                    <div class="dashboard-title">
                        <i class="fas fa-chart-line me-2"></i>FSO Issues Overview
                    </div>
                    
                    <!-- KPI Summary Row -->
                    <div class="row mb-4">
                        <!-- TOTAL FSO ISSUES -->
                        <div class="col-xl-2 col-lg-4 col-md-6 mb-3">
                            <div class="card kpi-card p-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="card-title">TOTAL FSO</h6>
                                        <div class="kpi-value text-primary" id="kpiTotalIssues">0</div>
                                    </div>
                                    <div class="align-self-center">
                                        <i class="fas fa-tasks fa-2x text-primary opacity-50"></i>
                                    </div>
                                </div>
                                <div class="small text-muted mt-2">All FSO issues</div>
                            </div>
                        </div>
                        <!-- UNIQUE SITES -->
                        <div class="col-xl-2 col-lg-4 col-md-6 mb-3">
                            <div class="card kpi-card p-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="card-title">UNIQUE SITES</h6>
                                        <div class="kpi-value text-secondary" id="kpiUniqueSites">0</div>
                                    </div>
                                    <div class="align-self-center">
                                        <i class="fas fa-map-marker-alt fa-2x text-secondary opacity-50"></i>
                                    </div>
                                </div>
                                <div class="small text-muted mt-2">Distinct site locations</div>
                            </div>
                        </div>
                        <!-- OPEN FSO -->
                        <div class="col-xl-2 col-lg-4 col-md-6 mb-3">
                            <div class="card kpi-card p-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="card-title">OPEN FSO</h6>
                                        <div class="kpi-value text-danger" id="kpiOpenIssues">0</div>
                                    </div>
                                    <div class="align-self-center">
                                        <i class="fas fa-exclamation-circle fa-2x text-danger opacity-50"></i>
                                    </div>
                                </div>
                                <div class="small text-muted mt-2">FSO issues pending</div>
                            </div>
                        </div>
                        <!-- CLOSED FSO -->
                        <div class="col-xl-2 col-lg-4 col-md-6 mb-3">
                            <div class="card kpi-card p-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="card-title">CLOSED FSO</h6>
                                        <div class="kpi-value text-success" id="kpiClosedIssues">0</div>
                                    </div>
                                    <div class="align-self-center">
                                        <i class="fas fa-check-circle fa-2x text-success opacity-50"></i>
                                    </div>
                                </div>
                                <div class="small text-muted mt-2">Resolved FSO issues</div>
                            </div>
                        </div>
                        <!-- HIGH PRIORITY -->
                        <div class="col-xl-2 col-lg-4 col-md-6 mb-3">
                            <div class="card kpi-card p-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="card-title">HIGH PRIORITY</h6>
                                        <div class="kpi-value text-warning" id="kpiHighPriority">0</div>
                                    </div>
                                    <div class="align-self-center">
                                        <i class="fas fa-flag fa-2x text-warning opacity-50"></i>
                                    </div>
                                </div>
                                <div class="small text-muted mt-2">P1 FSO issues</div>
                            </div>
                        </div>
                        <!-- AGING > 1 MONTH -->
                        <div class="col-xl-2 col-lg-4 col-md-6 mb-3">
                            <div class="card kpi-card p-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="card-title">AGING > 1 MONTH</h6>
                                        <div class="kpi-value text-info" id="kpiAgingIssues">0</div>
                                    </div>
                                    <div class="align-self-center">
                                        <i class="fas fa-calendar-times fa-2x text-info opacity-50"></i>
                                    </div>
                                </div>
                                <div class="small text-muted mt-2">FSO >30 days old</div>
                            </div>
                        </div>
                    </div>

                    <!-- Filter and Search Row -->
                    <div class="row mb-4">
                        <div class="col-lg-12">
                            <div class="card filter-card">
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-3">
                                            <div class="input-group">
                                                <span class="input-group-text"><i class="fas fa-id-badge"></i></span>
                                                <input type="text" class="form-control" id="searchSiteId" placeholder="Search Site ID" onkeyup="applyFilters()">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="input-group">
                                                <span class="input-group-text"><i class="fas fa-exclamation-circle"></i></span>
                                                <select class="form-select" id="filterStatus" onchange="applyFilters()">
                                                    <option value="">All Status</option>
                                                    <option value="Open">Open</option>
                                                    <option value="Closed">Closed</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="input-group">
                                                <span class="input-group-text"><i class="fas fa-flag"></i></span>
                                                <select class="form-select" id="filterPriority" onchange="applyFilters()">
                                                    <option value="">All Priority</option>
                                                    <option value="P1">P1</option>
                                                    <option value="P2">P2</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="input-group">
                                                <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                                                <select class="form-select" id="filterCircle" onchange="applyFilters()">
                                                    <option value="">All Circles</option>
                                                    <!-- Options will be populated dynamically -->
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-md-3">
                                            <div class="input-group">
                                                <span class="input-group-text"><i class="fas fa-chart-bar"></i></span>
                                                <select class="form-select" id="filterCategory" onchange="applyFilters()">
                                                    <option value="">All Categories</option>
                                                    <!-- Options will be populated dynamically -->
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="input-group">
                                                <span class="input-group-text"><i class="fas fa-city"></i></span>
                                                <select class="form-select" id="filterCity" onchange="applyFilters()">
                                                    <option value="">All Cities</option>
                                                    <!-- Options will be populated dynamically -->
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="input-group">
                                                <span class="input-group-text"><i class="fas fa-industry"></i></span>
                                                <select class="form-select" id="filterArea" onchange="applyFilters()">
                                                    <option value="">All Areas</option>
                                                    <!-- Options will be populated dynamically -->
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="input-group">
                                                <span class="input-group-text"><i class="fas fa-tag"></i></span>
                                                <select class="form-select" id="filterVendor" onchange="applyFilters()">
                                                    <option value="">All Vendors</option>
                                                    <!-- Options will be populated dynamically -->
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-md-6">
                                            <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                                                <i class="fas fa-eraser me-1"></i> Clear All Filters
                                            </button>
                                        </div>
                                        <div class="col-md-6">
                                            <button class="btn btn-outline-primary w-100" onclick="fetchCSVData()">
                                                <i class="fas fa-sync me-1"></i> Refresh Data
                                            </button>
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-12">
                                            <div class="search-result-info" id="searchResultInfo" style="display: none;">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <h6 class="mb-1" id="searchResultTitle">Search Results</h6>
                                                        <small class="text-muted" id="searchResultText"></small>
                                                    </div>
                                                    <div>
                                                        <button class="btn btn-primary btn-sm" onclick="showDetailedTable()">
                                                            <i class="fas fa-table me-1"></i> Show Details
                                                        </button>
                                                        <button class="btn btn-outline-success btn-sm ms-2" onclick="exportToCSV()">
                                                            <i class="fas fa-download me-1"></i> Export
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Row 1 -->
                    <div class="row mb-4">
                        <div class="col-lg-4 mb-4">
                            <div class="chart-container">
                                <h6 class="chart-title"><i class="fas fa-chart-pie"></i>FSO Status Distribution</h6>
                                <div style="height: 250px; position: relative;">
                                    <canvas id="statusChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 mb-4">
                            <div class="chart-container">
                                <h6 class="chart-title"><i class="fas fa-chart-bar"></i>FSO Priority Distribution</h6>
                                <div style="height: 250px; position: relative;">
                                    <canvas id="priorityChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 mb-4">
                            <div class="chart-container">
                                <h6 class="chart-title"><i class="fas fa-chart-line"></i>FSO by Circle</h6>
                                <div style="height: 250px; position: relative;">
                                    <canvas id="circleChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Row 2 -->
                    <div class="row mb-4">
                        <div class="col-lg-4 mb-4">
                            <div class="chart-container">
                                <h6 class="chart-title"><i class="fas fa-industry"></i>FSO by Vendor</h6>
                                <div style="height: 250px; position: relative;">
                                    <canvas id="vendorChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 mb-4">
                            <div class="chart-container">
                                <h6 class="chart-title"><i class="fas fa-exclamation-triangle"></i>Problem Categories</h6>
                                <div style="height: 250px; position: relative;">
                                    <canvas id="categoryChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 mb-4">
                            <div class="chart-container">
                                <h6 class="chart-title"><i class="fas fa-calendar-alt"></i>Aging Distribution</h6>
                                <div style="height: 250px; position: relative;">
                                    <canvas id="agingChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Summary Tables -->
                    <div class="row mb-4">
                        <!-- Top Sites with FSO Issues -->
                        <div class="col-lg-4 mb-4">
                            <div class="chart-container">
                                <h6 class="chart-title"><i class="fas fa-building"></i>Top Sites with FSO Issues</h6>
                                <div class="table-responsive" style="max-height: 300px;">
                                    <table class="table table-sm table-hover">
                                        <thead>
                                            <tr>
                                                <th>Site ID</th>
                                                <th class="text-end">Issues</th>
                                                <th class="text-end">Open</th>
                                                <th class="text-end">P1</th>
                                            </tr>
                                        </thead>
                                        <tbody id="topSitesBody">
                                            <tr><td colspan="4" class="text-center py-3">Loading FSO data...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Aging Analysis for FSO -->
                        <div class="col-lg-4 mb-4">
                            <div class="chart-container">
                                <h6 class="chart-title"><i class="fas fa-calendar-alt"></i>Oldest Open FSO Issues</h6>
                                <div class="table-responsive" style="max-height: 300px;">
                                    <table class="table table-sm table-hover">
                                        <thead>
                                            <tr>
                                                <th>Site ID</th>
                                                <th>Problem</th>
                                                <th class="text-end">Aging</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="agingIssuesBody">
                                            <tr><td colspan="4" class="text-center py-3">Loading FSO data...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Top Problem Categories for FSO -->
                        <div class="col-lg-4 mb-4">
                            <div class="chart-container">
                                <h6 class="chart-title"><i class="fas fa-chart-pie"></i>Top Problem Categories</h6>
                                <div class="table-responsive" style="max-height: 300px;">
                                    <table class="table table-sm table-hover">
                                        <thead>
                                            <tr>
                                                <th>Problem Category</th>
                                                <th class="text-end">Issues</th>
                                                <th class="text-end">% of Total</th>
                                            </tr>
                                        </thead>
                                        <tbody id="topCategoriesBody">
                                            <tr><td colspan="3" class="text-center py-3">Loading FSO data...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Circle Performance Summary -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="chart-container">
                                <h6 class="chart-title"><i class="fas fa-map-marked-alt"></i>Circle Performance Summary (FSO)</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                        <thead>
                                            <tr>
                                                <th>Circle</th>
                                                <th class="text-end">Total Issues</th>
                                                <th class="text-end">Open Issues</th>
                                                <th class="text-end">P1 Issues</th>
                                                <th class="text-end">Avg Aging</th>
                                                <th class="text-end">Unique Sites</th>
                                                <th class="text-end">Closed Rate</th>
                                            </tr>
                                        </thead>
                                        <tbody id="circleSummaryBody">
                                            <tr><td colspan="7" class="text-center py-3">Loading FSO data...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- City Performance Summary -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="chart-container">
                                <h6 class="chart-title"><i class="fas fa-city"></i>City Performance Summary (FSO)</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                        <thead>
                                            <tr>
                                                <th>City</th>
                                                <th>Area IOH</th>
                                                <th class="text-end">Total Issues</th>
                                                <th class="text-end">Open Issues</th>
                                                <th class="text-end">P1 Issues</th>
                                                <th class="text-end">Avg Aging</th>
                                                <th class="text-end">Unique Sites</th>
                                                <th class="text-end">Closed Rate</th>
                                            </tr>
                                        </thead>
                                        <tbody id="citySummaryBody">
                                            <tr><td colspan="8" class="text-center py-3">Loading FSO data...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Detailed FSO Issues Table (Hidden by default) -->
                    <div class="row">
                        <div class="col-12">
                            <div class="main-table-container" id="detailedTableContainer">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0" style="font-family: var(--font-plus-jakarta); font-weight: 700; font-size: 14px;">
                                        <i class="fas fa-table me-2"></i>Detailed FSO Issues
                                    </h6>
                                    <div>
                                        <span class="info-badge me-2" id="tableCountBadge">Showing 0 issues</span>
                                        <button class="btn btn-outline-secondary btn-sm" onclick="hideDetailedTable()">
                                            <i class="fas fa-times me-1"></i> Hide
                                        </button>
                                        <button class="btn btn-outline-success btn-sm ms-2" onclick="exportToCSV()">
                                            <i class="fas fa-download me-1"></i> Export
                                        </button>
                                    </div>
                                </div>
                                <div class="main-table-wrapper">
                                    <div class="table-responsive" id="issuesTableContainer">
                                        <table class="table table-striped table-hover table-sm">
                                            <thead>
                                                <tr>
                                                    <th class="cursor-pointer" onclick="sortTable('siteId')">
                                                        Site ID <i class="fas fa-sort ms-1"></i>
                                                    </th>
                                                    <th class="cursor-pointer" onclick="sortTable('problemCategory')">
                                                        Problem <i class="fas fa-sort ms-1"></i>
                                                    </th>
                                                    <th class="cursor-pointer" onclick="sortTable('priority')">
                                                        Priority <i class="fas fa-sort ms-1"></i>
                                                    </th>
                                                    <th class="cursor-pointer" onclick="sortTable('status')">
                                                        Status <i class="fas fa-sort ms-1"></i>
                                                    </th>
                                                    <th class="cursor-pointer" onclick="sortTable('aging')">
                                                        Aging <i class="fas fa-sort ms-1"></i>
                                                    </th>
                                                    <th class="cursor-pointer" onclick="sortTable('rootCause')">
                                                        Root Cause <i class="fas fa-sort ms-1"></i>
                                                    </th>
                                                    <th class="cursor-pointer" onclick="sortTable('action')">
                                                        Action <i class="fas fa-sort ms-1"></i>
                                                    </th>
                                                    <th>Circle</th>
                                                    <th>Vendor</th>
                                                    <th>City</th>
                                                    <th>Area</th>
                                                    <th>Open Date</th>
                                                </tr>
                                            </thead>
                                            <tbody id="detailedIssuesTableBody">
                                                <!-- Data akan diisi oleh JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- TAB 2: REGIONAL RANKING (by Area IOH) -->
                <div class="tab-pane fade" id="regional" role="tabpanel" aria-labelledby="regional-tab">
                    <div class="dashboard-title">
                        <i class="fas fa-map-marked-alt me-2"></i>Regional Ranking by Area IOH - Open Issues Only
                    </div>
                    
                    <!-- Regional Ranking Info -->
                    <div class="row mb-4">
                        <div class="col-lg-12">
                            <div class="card filter-card">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="input-group">
                                                <span class="input-group-text"><i class="fas fa-user"></i></span>
                                                <input type="text" class="form-control" value="PIC = FSO" disabled>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="input-group">
                                                <span class="input-group-text"><i class="fas fa-exclamation-circle"></i></span>
                                                <input type="text" class="form-control" value="Status = Open / New Open / Re-Open" disabled>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-12">
                                            <div class="search-result-info" id="regionalInfo" style="background: #e0f2fe; border-left-color: #0284c7;">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <h6 class="mb-1"><i class="fas fa-info-circle me-1"></i>Regional Ranking Info</h6>
                                                        <small class="text-muted" id="regionalInfoText">Menampilkan distinct count Site ID per Area IOH dan Problem Category (Status: Open/New Open/Re-Open)</small>
                                                    </div>
                                                    <div>
                                                        <span class="badge bg-primary" id="regionalTotalSites">0</span> Total Sites
                                                        <button class="btn btn-sm btn-outline-primary ms-3" onclick="exportRegionalToCSV()">
                                                            <i class="fas fa-download me-1"></i> Export
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Regional Ranking Matrix Table by Area IOH -->
                    <div class="matrix-table-container">
                        <div class="table-responsive">
                            <table class="matrix-table" id="regionalRankingTable">
                                <thead>
                                    <tr>
                                        <th>Area IOH</th>
                                        <th>ASM</th>
                                        <th>QPSK</th>
                                        <th>RANK2</th>
                                        <th>RTWP</th>
                                        <th>SIA</th>
                                        <th>Sleeping Cell</th>
                                        <th>VSWR</th>
                                        <th class="total-column">Grand Total</th>
                                    </tr>
                                </thead>
                                <tbody id="regionalRankingBody">
                                    <tr>
                                        <td colspan="8" class="text-center py-4">Loading regional ranking data...</td>
                                    </tr>
                                </tbody>
                                <tfoot id="regionalRankingFooter">
                                    <!-- Will be populated dynamically -->
                                </tfoot>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Regional Ranking Notes -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="alert alert-info d-flex align-items-center" role="alert">
                                <i class="fas fa-lightbulb me-2 fa-lg"></i>
                                <div>
                                    <strong>Notes:</strong> 
                                    <ul class="mb-0">
                                        <li>Hanya menampilkan issue dengan status <strong>Open, New Open, dan Re-Open</strong></li>
                                        <li>Values menunjukkan jumlah <strong>Site ID unik (distinct count)</strong> per Area IOH untuk setiap Problem Category</li>
                                        <li>Satu Site ID bisa memiliki multiple issue, tapi hanya dihitung sekali per kategori</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="text-center small text-muted">
                    <p class="mb-1" style="font-family: var(--font-inter);">
                        <i class="fas fa-database me-1"></i> Data Source: Google Sheets | 
                        <i class="fas fa-filter me-1 ms-3"></i> Filter: PIC = FSO | Status = Open/New Open/Re-Open |
                        <i class="fas fa-clock me-1 ms-3"></i> Last Updated: <span id="lastUpdatedTime">-</span> |
                        <i class="fas fa-info-circle me-1 ms-3"></i> Total FSO Records: <span id="totalRecords">0</span>
                    </p>
                    <p class="mb-0" style="font-family: var(--font-inter);">
                        <button class="btn btn-link btn-sm text-decoration-none" onclick="fetchCSVData()">
                            <i class="fas fa-redo me-1"></i> Refresh Data
                        </button>
                        <button class="btn btn-link btn-sm text-decoration-none" onclick="toggleAutoRefresh()" id="autoRefreshToggle">
                            <i class="fas fa-sync me-1"></i> Auto-Refresh: <span id="autoRefreshStatus">ON</span>
                        </button>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Register the plugin
        Chart.register(ChartDataLabels);
        
        // ==================== KONFIGURASI ====================
        const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSchfOZU-jK0FoiBjpyWsAezO2MdnPkJUh5bKRbs1sAI6DpJ0DocsMNBL_89QMjnnho1X9x_bKwEqjD/pub?gid=0&single=true&output=csv";

        // ==================== VARIABEL GLOBAL ====================
        let allFsoData = [];
        let filteredFsoData = [];
        let currentSort = { column: 'aging', direction: 'desc' };
        let statusChart, priorityChart, circleChart, vendorChart, categoryChart, agingChart;
        let autoRefreshInterval = null;
        let isAutoRefresh = true;
        const AUTO_REFRESH_INTERVAL = 30000; // 30 detik
        const FSO_PIC = "FSO";
        
        // Daftar problem categories untuk regional ranking
        const PROBLEM_CATEGORIES = [
            'ASM',
            'QPSK',
            'RANK2',
            'RTWP',
            'SIA',
            'Sleeping Cell',
            'VSWR'
        ];

        // Status Open yang termasuk (Open, New Open, Re-Open)
        const OPEN_STATUSES = ['Open', 'New Open', 'Re-Open'];

        // ==================== FUNGSI INISIALISASI ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('FSO Dashboard initializing...');
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            // Setup auto-refresh
            setupAutoRefresh();
            
            // Load data
            fetchCSVData();
            
            // Initialize Bootstrap tabs
            var triggerTabList = [].slice.call(document.querySelectorAll('#dashboardTabs button'))
            triggerTabList.forEach(function (triggerEl) {
                var tabTrigger = new bootstrap.Tab(triggerEl)
                triggerEl.addEventListener('click', function (event) {
                    event.preventDefault()
                    tabTrigger.show()
                })
            })
        });

        // ==================== FUNGSI DATA ====================
        function fetchCSVData() {
            console.log('Fetching CSV data for FSO PIC from:', CSV_URL);
            showLoading(true);
            updateDashboardStatus('loading', 'Fetching FSO data...');
            
            Papa.parse(CSV_URL, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    console.log('CSV parsing complete. Total rows:', results.data.length);
                    
                    if (results.data && results.data.length > 0) {
                        processFsoData(results.data);
                        debugData();
                        updateDashboardStatus('success', `FSO data loaded (${allFsoData.length} records)`);
                    } else {
                        console.warn('No data found in CSV');
                        showError('No data found in the CSV file.');
                        updateDashboardStatus('error', 'No data found');
                    }
                    showLoading(false);
                    updateLastUpdatedTime();
                    
                    // Update FSO count badge
                    document.getElementById('fsoCountBadge').textContent = `${allFsoData.length} FSO Issues`;
                    
                    // Hide search result info and detailed table initially
                    document.getElementById('searchResultInfo').style.display = 'none';
                    document.getElementById('detailedTableContainer').style.display = 'none';
                    
                    // Update regional ranking
                    updateRegionalRanking();
                },
                error: function(error) {
                    console.error('Error fetching CSV:', error);
                    showError('Failed to load data from CSV. Please check the URL or internet connection.');
                    updateDashboardStatus('error', 'Failed to load data');
                    showLoading(false);
                }
            });
        }

        function processFsoData(rawData) {
            allFsoData = [];
            const circles = new Set();
            const problemCategories = new Set();
            const vendors = new Set();
            const cities = new Set();
            const areas = new Set();
            const rootCauses = new Set();
            
            rawData.forEach(row => {
                try {
                    // Check if PIC is FSO (case insensitive)
                    const pic = (row['PIC'] || row['pic'] || '').toString().trim().toUpperCase();
                    
                    // Only include records where PIC is FSO
                    if (pic !== FSO_PIC) return;
                    
                    const siteId = row['SITE ID'] || row['siteId'] || row['Site ID'] || '';
                    const problemCategory = row['Problem Category'] || row['problemCategory'] || 'Unknown';
                    const priority = row['Priority'] || row['priority'] || 'P2';
                    const status = row['Status(1)'] || row['Status'] || row['status'] || 'Open';
                    const aging = parseInt(row['Aging']) || parseInt(row['aging']) || 0;
                    const rootCause = row['Root Cause Category'] || row['rootCause'] || 'Unknown';
                    const action = row['Action Performed'] || row['action'] || '';
                    const circle = row['Circle'] || row['circle'] || '';
                    const vendor = row['Vendor'] || row['vendor'] || '';
                    const openDate = row['Open Date'] || '';
                    const closedDate = row['Closed Date'] || '';
                    const city = row['City'] || 'Unknown';
                    const area = row['Area IOH'] || row['area'] || 'Unknown';
                    
                    if (!siteId) return;
                    
                    // Clean and normalize data
                    const cleanStatus = String(status).trim();
                    const cleanPriority = String(priority).trim().toUpperCase();
                    const cleanCircle = String(circle).trim();
                    const cleanVendor = String(vendor).trim();
                    const cleanCategory = String(problemCategory).trim();
                    const cleanCity = String(city).trim();
                    const cleanArea = String(area).trim();
                    const cleanRootCause = String(rootCause).trim() || 'Unknown';
                    
                    // Add to sets for filters
                    if (cleanCircle) circles.add(cleanCircle);
                    if (cleanCategory) problemCategories.add(cleanCategory);
                    if (cleanVendor) vendors.add(cleanVendor);
                    if (cleanCity) cities.add(cleanCity);
                    if (cleanArea) areas.add(cleanArea);
                    if (cleanRootCause) rootCauses.add(cleanRootCause);
                    
                    const processedRow = {
                        raw: row,
                        siteId: siteId,
                        problemCategory: cleanCategory,
                        priority: cleanPriority === 'P1' ? 'P1' : 'P2',
                        status: cleanStatus,
                        aging: aging,
                        pic: FSO_PIC,
                        rootCause: cleanRootCause,
                        action: action,
                        circle: cleanCircle,
                        vendor: cleanVendor,
                        openDate: openDate,
                        closedDate: closedDate,
                        city: cleanCity,
                        area: cleanArea,
                        isHighAging: aging > 30,
                        isCritical: aging > 60
                    };
                    
                    allFsoData.push(processedRow);
                } catch (error) {
                    console.warn('Error processing FSO row:', error);
                }
            });
            
            console.log(`Filtered to ${allFsoData.length} FSO issue records`);
            
            // Update filter options
            updateFilterOptions('filterCircle', Array.from(circles));
            updateFilterOptions('filterCategory', Array.from(problemCategories));
            updateFilterOptions('filterCity', Array.from(cities).sort());
            updateFilterOptions('filterArea', Array.from(areas).sort());
            updateFilterOptions('filterVendor', Array.from(vendors).sort());
            
            applyFilters();
        }

        function updateFilterOptions(selectId, options) {
            const filterSelect = document.getElementById(selectId);
            if (!filterSelect) return;
            
            // Set placeholder text based on selectId
            let placeholderText = "All";
            if (selectId === 'filterCircle') placeholderText = "All Circles";
            else if (selectId === 'filterCategory') placeholderText = "All Categories";
            else if (selectId === 'filterCity') placeholderText = "All Cities";
            else if (selectId === 'filterArea') placeholderText = "All Areas";
            else if (selectId === 'filterVendor') placeholderText = "All Vendors";
            else if (selectId === 'filterStatus') placeholderText = "All Status";
            else if (selectId === 'filterPriority') placeholderText = "All Priority";
            
            filterSelect.innerHTML = `<option value="">${placeholderText}</option>`;
            
            Array.from(options).sort().forEach(option => {
                if (option && option.trim()) {
                    const opt = document.createElement('option');
                    opt.value = option;
                    opt.textContent = option;
                    filterSelect.appendChild(opt);
                }
            });
        }

        function debugData() {
            console.log('=== FSO DATA DEBUG ===');
            console.log('Total FSO records:', allFsoData.length);
            if (allFsoData.length > 0) {
                console.log('Sample FSO records (first 3):', allFsoData.slice(0, 3));
                console.log('Status distribution:', {
                    Open: allFsoData.filter(d => OPEN_STATUSES.includes(d.status)).length,
                    Closed: allFsoData.filter(d => d.status === 'Closed').length
                });
                console.log('Priority distribution:', {
                    P1: allFsoData.filter(d => d.priority === 'P1').length,
                    P2: allFsoData.filter(d => d.priority === 'P2').length
                });
                console.log('All circles:', [...new Set(allFsoData.map(d => d.circle))]);
                console.log('All vendors:', [...new Set(allFsoData.map(d => d.vendor))]);
                console.log('All categories:', [...new Set(allFsoData.map(d => d.problemCategory))]);
                console.log('All areas:', [...new Set(allFsoData.map(d => d.area))].filter(area => area));
            }
            console.log('=== END FSO DEBUG ===');
        }

        // ==================== FUNGSI REGIONAL RANKING (by Area IOH) ====================
        function updateRegionalRanking() {
            // Filter data: PIC = FSO dan Status = Open/New Open/Re-Open
            let regionalData = allFsoData.filter(issue => 
                issue.pic === 'FSO' && OPEN_STATUSES.includes(issue.status)
            );
            
            // Group by Area IOH dan Problem Category untuk distinct Site ID
            const areaStats = {};
            const allAreas = new Set();
            
            regionalData.forEach(issue => {
                const area = issue.area || 'Unknown';
                const category = issue.problemCategory;
                const siteId = issue.siteId;
                
                allAreas.add(area);
                
                if (!areaStats[area]) {
                    areaStats[area] = {
                        area: area,
                        sites: new Set(),
                        categories: {}
                    };
                    
                    // Initialize categories
                    PROBLEM_CATEGORIES.forEach(cat => {
                        areaStats[area].categories[cat] = new Set();
                    });
                }
                
                // Add site to area's total sites
                areaStats[area].sites.add(siteId);
                
                // Add site to specific category if it matches one of our defined categories
                if (PROBLEM_CATEGORIES.includes(category)) {
                    areaStats[area].categories[category].add(siteId);
                }
            });
            
            // Convert to array and sort alphabetically
            const sortedAreas = Array.from(allAreas).filter(area => area !== 'Unknown').sort();
            
            // Build table HTML
            let tbodyHtml = '';
            let grandTotal = 0;
            const categoryTotals = {};
            PROBLEM_CATEGORIES.forEach(cat => categoryTotals[cat] = 0);
            
            sortedAreas.forEach(area => {
                const stats = areaStats[area] || { categories: {}, sites: new Set() };
                let rowHtml = `<tr>`;
                rowHtml += `<td><strong>${area}</strong></td>`;
                
                let rowTotal = 0;
                
                PROBLEM_CATEGORIES.forEach(cat => {
                    const siteSet = stats.categories[cat] || new Set();
                    const count = siteSet.size;
                    categoryTotals[cat] += count;
                    rowTotal += count;
                    rowHtml += `<td>${count || ''}</td>`;
                });
                
                grandTotal += rowTotal;
                rowHtml += `<td class="total-column"><strong>${rowTotal}</strong></td>`;
                rowHtml += `</tr>`;
                
                tbodyHtml += rowHtml;
            });
            
            // Add footer row
            let footerHtml = `<tr>`;
            footerHtml += `<td><strong>Grand Total</strong></td>`;
            
            PROBLEM_CATEGORIES.forEach(cat => {
                footerHtml += `<td><strong>${categoryTotals[cat]}</strong></td>`;
            });
            
            footerHtml += `<td class="total-column"><strong>${grandTotal}</strong></td>`;
            footerHtml += `</tr>`;
            
            // Update table
            if (tbodyHtml) {
                document.getElementById('regionalRankingBody').innerHTML = tbodyHtml;
                document.getElementById('regionalRankingFooter').innerHTML = footerHtml;
            } else {
                document.getElementById('regionalRankingBody').innerHTML = '<tr><td colspan="8" class="text-center py-4">No open issues found for FSO</td></tr>';
                document.getElementById('regionalRankingFooter').innerHTML = '';
            }
            
            document.getElementById('regionalTotalSites').textContent = grandTotal;
        }

        function exportRegionalToCSV() {
            const table = document.getElementById('regionalRankingTable');
            const rows = table.querySelectorAll('tr');
            
            let csv = [];
            
            // Get headers (row 0)
            const headers = [];
            rows[0].querySelectorAll('th').forEach(th => {
                headers.push(th.innerText);
            });
            csv.push(headers.join(','));
            
            // Get data rows (skip header row)
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                const rowData = [];
                row.querySelectorAll('td').forEach(td => {
                    rowData.push(td.innerText.replace(/,/g, ''));
                });
                if (rowData.length > 0) {
                    csv.push(rowData.join(','));
                }
            }
            
            const blob = new Blob([csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const dateStr = new Date().toISOString().slice(0,10);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `regional_ranking_by_area_fso_open_${dateStr}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('Regional ranking by Area IOH exported to CSV');
        }

        // ==================== FUNGSI FILTER & PENCARIAN (untuk tab Overview) ====================
        function applyFilters() {
            const searchSiteId = document.getElementById('searchSiteId').value.toLowerCase().trim();
            const filterStatus = document.getElementById('filterStatus').value;
            const filterPriority = document.getElementById('filterPriority').value;
            const filterCircle = document.getElementById('filterCircle').value;
            const filterCategory = document.getElementById('filterCategory').value;
            const filterCity = document.getElementById('filterCity').value;
            const filterArea = document.getElementById('filterArea').value;
            const filterVendor = document.getElementById('filterVendor').value;
            
            filteredFsoData = allFsoData.filter(issue => {
                const siteIdMatch = !searchSiteId || 
                    issue.siteId.toLowerCase().includes(searchSiteId);
                
                const statusMatch = !filterStatus || 
                    issue.status === filterStatus;
                
                const priorityMatch = !filterPriority || 
                    issue.priority === filterPriority;
                
                const circleMatch = !filterCircle || 
                    issue.circle === filterCircle;
                
                const categoryMatch = !filterCategory || 
                    issue.problemCategory === filterCategory;
                
                const cityMatch = !filterCity || 
                    issue.city === filterCity;
                
                const areaMatch = !filterArea || 
                    issue.area === filterArea;
                
                const vendorMatch = !filterVendor || 
                    issue.vendor === filterVendor;
                
                return siteIdMatch && statusMatch && priorityMatch && circleMatch && categoryMatch && cityMatch && areaMatch && vendorMatch;
            });
            
            updateSummaryKPIs();
            updateCharts();
            updateSummaryTables();
            updateSearchResultInfo();
        }

        function updateSearchResultInfo() {
            const searchResultInfo = document.getElementById('searchResultInfo');
            const searchResultText = document.getElementById('searchResultText');
            const searchResultTitle = document.getElementById('searchResultTitle');
            
            const searchSiteId = document.getElementById('searchSiteId').value;
            const filterStatus = document.getElementById('filterStatus').value;
            const filterPriority = document.getElementById('filterPriority').value;
            const filterCircle = document.getElementById('filterCircle').value;
            const filterCategory = document.getElementById('filterCategory').value;
            const filterCity = document.getElementById('filterCity').value;
            const filterArea = document.getElementById('filterArea').value;
            const filterVendor = document.getElementById('filterVendor').value;
            
            // Build search description
            let searchDescription = [];
            if (searchSiteId) searchDescription.push(`Site ID: "${searchSiteId}"`);
            if (filterStatus) searchDescription.push(`Status: ${filterStatus}`);
            if (filterPriority) searchDescription.push(`Priority: ${filterPriority}`);
            if (filterCircle) searchDescription.push(`Circle: ${filterCircle}`);
            if (filterCategory) searchDescription.push(`Category: ${filterCategory}`);
            if (filterCity) searchDescription.push(`City: ${filterCity}`);
            if (filterArea) searchDescription.push(`Area: ${filterArea}`);
            if (filterVendor) searchDescription.push(`Vendor: ${filterVendor}`);
            
            if (searchDescription.length > 0) {
                searchResultTitle.textContent = `FSO Search Results (${filteredFsoData.length} issues found)`;
                searchResultText.textContent = `Filters applied: ${searchDescription.join(', ')}`;
                searchResultInfo.style.display = 'block';
                
                // Hide detailed table if showing
                document.getElementById('detailedTableContainer').style.display = 'none';
            } else {
                searchResultInfo.style.display = 'none';
            }
        }

        function clearFilters() {
            document.getElementById('searchSiteId').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterPriority').value = '';
            document.getElementById('filterCircle').value = '';
            document.getElementById('filterCategory').value = '';
            document.getElementById('filterCity').value = '';
            document.getElementById('filterArea').value = '';
            document.getElementById('filterVendor').value = '';
            
            applyFilters();
        }

        function showDetailedTable() {
            document.getElementById('detailedTableContainer').style.display = 'flex';
            updateDetailedIssuesTable();
            
            // Scroll to the table
            document.getElementById('detailedTableContainer').scrollIntoView({ 
                behavior: 'smooth' 
            });
        }

        function hideDetailedTable() {
            document.getElementById('detailedTableContainer').style.display = 'none';
        }

        // ==================== FUNGSI UPDATE UI (untuk tab Overview) ====================
        function updateSummaryKPIs() {
            const totalIssues = allFsoData.length;
            
            // Calculate unique sites
            const uniqueSites = new Set(allFsoData.map(issue => issue.siteId)).size;
            
            const openIssues = allFsoData.filter(issue => OPEN_STATUSES.includes(issue.status)).length;
            const closedIssues = allFsoData.filter(issue => issue.status === 'Closed').length;
            const highPriorityIssues = allFsoData.filter(issue => issue.priority === 'P1').length;
            const agingIssues = allFsoData.filter(issue => issue.aging > 30).length;
            
            document.getElementById('kpiTotalIssues').textContent = totalIssues.toLocaleString();
            document.getElementById('kpiUniqueSites').textContent = uniqueSites.toLocaleString();
            document.getElementById('kpiOpenIssues').textContent = openIssues.toLocaleString();
            document.getElementById('kpiClosedIssues').textContent = closedIssues.toLocaleString();
            document.getElementById('kpiHighPriority').textContent = highPriorityIssues.toLocaleString();
            document.getElementById('kpiAgingIssues').textContent = agingIssues.toLocaleString();
            
            // Update total records
            document.getElementById('totalRecords').textContent = totalIssues;
        }

        function updateCharts() {
            // Update Status Chart
            const statusCounts = {
                'Open': filteredFsoData.filter(issue => OPEN_STATUSES.includes(issue.status)).length,
                'Closed': filteredFsoData.filter(issue => issue.status === 'Closed').length
            };
            
            if (statusChart) statusChart.destroy();
            const statusCtx = document.getElementById('statusChart');
            if (statusCtx) {
                statusChart = new Chart(statusCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Open', 'Closed'],
                        datasets: [{
                            data: [statusCounts.Open, statusCounts.Closed],
                            backgroundColor: ['#dc3545', '#28a745'],
                            borderWidth: 1,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '65%',
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    font: {
                                        family: 'Inter',
                                        size: 10
                                    }
                                }
                            },
                            datalabels: {
                                display: true,
                                color: '#ffffff',
                                font: {
                                    family: 'Inter',
                                    weight: 'bold',
                                    size: 12
                                },
                                formatter: (value, context) => {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${percentage}%`;
                                },
                                anchor: 'center',
                                align: 'center',
                                offset: 0
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Update Priority Chart
            const priorityCounts = {
                'P1': filteredFsoData.filter(issue => issue.priority === 'P1').length,
                'P2': filteredFsoData.filter(issue => issue.priority === 'P2').length
            };
            
            if (priorityChart) priorityChart.destroy();
            const priorityCtx = document.getElementById('priorityChart');
            if (priorityCtx) {
                const maxValue = Math.max(priorityCounts.P1, priorityCounts.P2);
                const yAxisMax = Math.ceil(maxValue * 1.2);
                
                priorityChart = new Chart(priorityCtx, {
                    type: 'bar',
                    data: {
                        labels: ['P1 (High)', 'P2 (Normal)'],
                        datasets: [{
                            label: 'FSO Issues',
                            data: [priorityCounts.P1, priorityCounts.P2],
                            backgroundColor: ['#fd7e14', '#6c757d'],
                            borderWidth: 0,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            datalabels: {
                                display: true,
                                color: '#000000',
                                font: {
                                    family: 'Inter',
                                    weight: 'bold',
                                    size: 12
                                },
                                formatter: (value) => {
                                    return value;
                                },
                                anchor: 'end',
                                align: 'top',
                                offset: 4
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: yAxisMax,
                                ticks: {
                                    font: {
                                        family: 'Inter',
                                        size: 10
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    font: {
                                        family: 'Inter',
                                        size: 11
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Update Circle Chart
            const circleCounts = {};
            filteredFsoData.forEach(issue => {
                const circle = issue.circle || 'Unknown';
                circleCounts[circle] = (circleCounts[circle] || 0) + 1;
            });
            
            const sortedCircles = Object.entries(circleCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            if (circleChart) circleChart.destroy();
            const circleCtx = document.getElementById('circleChart');
            if (circleCtx) {
                circleChart = new Chart(circleCtx, {
                    type: 'pie',
                    data: {
                        labels: sortedCircles.map(item => item[0]),
                        datasets: [{
                            data: sortedCircles.map(item => item[1]),
                            backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    font: {
                                        family: 'Inter',
                                        size: 9
                                    },
                                    generateLabels: function(chart) {
                                        const data = chart.data;
                                        if (data.labels.length && data.datasets.length) {
                                            const dataset = data.datasets[0];
                                            return data.labels.map((label, i) => {
                                                const value = dataset.data[i];
                                                const total = dataset.data.reduce((a, b) => a + b, 0);
                                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                                return {
                                                    text: `${label}: ${value} (${percentage}%)`,
                                                    fillStyle: dataset.backgroundColor[i],
                                                    hidden: false,
                                                    index: i
                                                };
                                            });
                                        }
                                        return [];
                                    }
                                }
                            },
                            datalabels: {
                                display: true,
                                color: '#ffffff',
                                font: {
                                    family: 'Inter',
                                    weight: 'bold',
                                    size: 11
                                },
                                formatter: (value, context) => {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${percentage}%`;
                                },
                                anchor: 'center',
                                align: 'center',
                                offset: 0
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Update Vendor Chart
            const vendorCounts = {};
            filteredFsoData.forEach(issue => {
                const vendor = issue.vendor || 'Unknown';
                vendorCounts[vendor] = (vendorCounts[vendor] || 0) + 1;
            });
            
            const sortedVendors = Object.entries(vendorCounts)
                .sort((a, b) => b[1] - a[1]);
            
            if (vendorChart) vendorChart.destroy();
            const vendorCtx = document.getElementById('vendorChart');
            if (vendorCtx) {
                vendorChart = new Chart(vendorCtx, {
                    type: 'bar',
                    data: {
                        labels: sortedVendors.map(item => item[0]),
                        datasets: [{
                            label: 'FSO Issues',
                            data: sortedVendors.map(item => item[1]),
                            backgroundColor: sortedVendors.map(item => 
                                item[0].toLowerCase().includes('nokia') ? '#142c8e' :
                                item[0].toLowerCase().includes('huawei') ? '#d4001a' :
                                '#6b7280'
                            ),
                            borderWidth: 0,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            datalabels: {
                                display: true,
                                color: '#000000',
                                font: {
                                    family: 'Inter',
                                    weight: 'bold',
                                    size: 11
                                },
                                formatter: (value) => {
                                    return value;
                                },
                                anchor: 'end',
                                align: 'top',
                                offset: 4
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    font: {
                                        family: 'Inter',
                                        size: 10
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    font: {
                                        family: 'Inter',
                                        size: 10
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Update Category Chart - MENAMPILKAN SEMUA KATEGORI
            const categoryCounts = {};
            filteredFsoData.forEach(issue => {
                const category = issue.problemCategory || 'Unknown';
                categoryCounts[category] = (categoryCounts[category] || 0) + 1;
            });

            const allCategories = Object.entries(categoryCounts)
                .sort((a, b) => b[1] - a[1]);

            if (categoryChart) categoryChart.destroy();
            const categoryCtx = document.getElementById('categoryChart');
            if (categoryCtx) {
                if (allCategories.length === 1) {
                    categoryChart = new Chart(categoryCtx, {
                        type: 'doughnut',
                        data: {
                            labels: [allCategories[0][0]],
                            datasets: [{
                                data: [allCategories[0][1]],
                                backgroundColor: ['#3b82f6'],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            cutout: '65%',
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        font: {
                                            family: 'Inter',
                                            size: 11
                                        }
                                    }
                                },
                                datalabels: {
                                    display: true,
                                    color: '#ffffff',
                                    font: {
                                        family: 'Inter',
                                        weight: 'bold',
                                        size: 14
                                    },
                                    formatter: (value, context) => {
                                        const total = context.dataset.data.reduce((acc, val) => acc + val, 0);
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return `${value} (${percentage}%)`;
                                    },
                                    anchor: 'center',
                                    align: 'center',
                                    offset: 0
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.label || '';
                                            const value = context.raw || 0;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                            return `${label}: ${value} (${percentage}%)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                } else if (allCategories.length > 0) {
                    const maxValue = Math.max(...allCategories.map(item => item[1]));
                    const xAxisMax = Math.ceil(maxValue * 1.2);
                    
                    categoryChart = new Chart(categoryCtx, {
                        type: 'bar',
                        data: {
                            labels: allCategories.map(item => item[0]),
                            datasets: [{
                                label: 'Issues',
                                data: allCategories.map(item => item[1]),
                                backgroundColor: allCategories.map((_, index) => {
                                    const colors = [
                                        '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
                                        '#ec4899', '#14b8a6', '#f97316', '#6b7280', '#6366f1',
                                        '#84cc16', '#06b6d4', '#d946ef', '#64748b', '#0ea5e9'
                                    ];
                                    return colors[index % colors.length];
                                }),
                                borderWidth: 0,
                                borderRadius: 4
                            }]
                        },
                        options: {
                            indexAxis: 'y',
                            responsive: true,
                            maintainAspectRatio: false,
                            layout: {
                                padding: {
                                    left: 10,
                                    right: 25,
                                    top: 10,
                                    bottom: 10
                                }
                            },
                            plugins: {
                                legend: { display: false },
                                datalabels: {
                                    display: true,
                                    color: '#000000',
                                    font: {
                                        family: 'Inter',
                                        weight: 'bold',
                                        size: 11
                                    },
                                    formatter: (value) => {
                                        return value;
                                    },
                                    anchor: 'end',
                                    align: 'right',
                                    offset: 4,
                                    clamp: true
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const value = context.raw || 0;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                            return `Count: ${value} (${percentage}%)`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    beginAtZero: true,
                                    max: xAxisMax,
                                    grid: {
                                        display: true,
                                        color: '#e5e7eb'
                                    },
                                    ticks: {
                                        font: {
                                            family: 'Inter',
                                            size: 10,
                                            weight: 'normal'
                                        },
                                        stepSize: Math.ceil(maxValue / 5)
                                    },
                                    title: {
                                        display: true,
                                        text: 'Jumlah Issues',
                                        font: {
                                            family: 'Inter',
                                            size: 11,
                                            weight: 'bold'
                                        },
                                        color: '#4b5563'
                                    }
                                },
                                y: {
                                    grid: {
                                        display: false
                                    },
                                    ticks: {
                                        font: {
                                            family: 'Inter',
                                            size: 11,
                                            weight: 'normal'
                                        },
                                        maxRotation: 0,
                                        minRotation: 0
                                    },
                                    title: {
                                        display: true,
                                        text: 'Problem Category',
                                        font: {
                                            family: 'Inter',
                                            size: 11,
                                            weight: 'bold'
                                        },
                                        color: '#4b5563'
                                    }
                                }
                            }
                        }
                    });
                } else {
                    categoryCtx.parentElement.innerHTML = '<div class="text-center py-5 text-muted">No category data available</div>';
                }
            }
            
            // Update Aging Distribution Chart
            const agingRanges = {
                '0-7 days': filteredFsoData.filter(issue => issue.aging <= 7).length,
                '8-14 days': filteredFsoData.filter(issue => issue.aging > 7 && issue.aging <= 14).length,
                '15-30 days': filteredFsoData.filter(issue => issue.aging > 14 && issue.aging <= 30).length,
                '31-60 days': filteredFsoData.filter(issue => issue.aging > 30 && issue.aging <= 60).length,
                '>60 days': filteredFsoData.filter(issue => issue.aging > 60).length
            };
            
            if (agingChart) agingChart.destroy();
            const agingCtx = document.getElementById('agingChart');
            if (agingCtx) {
                const agingValues = Object.values(agingRanges);
                const maxAgingValue = Math.max(...agingValues);
                const yAxisMaxAging = Math.ceil(maxAgingValue * 1.2);
                
                agingChart = new Chart(agingCtx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(agingRanges),
                        datasets: [{
                            label: 'FSO Issues',
                            data: Object.values(agingRanges),
                            backgroundColor: ['#28a745', '#17a2b8', '#ffc107', '#fd7e14', '#dc3545'],
                            borderWidth: 0,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            datalabels: {
                                display: true,
                                color: '#000000',
                                font: {
                                    family: 'Inter',
                                    weight: 'bold',
                                    size: 11
                                },
                                formatter: (value) => {
                                    return value;
                                },
                                anchor: 'end',
                                align: 'top',
                                offset: 4,
                                clamp: true
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return `Count: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: yAxisMaxAging,
                                grid: {
                                    display: true,
                                    color: '#e5e7eb'
                                },
                                ticks: {
                                    font: {
                                        family: 'Inter',
                                        size: 10
                                    },
                                    stepSize: Math.ceil(maxAgingValue / 5)
                                },
                                title: {
                                    display: true,
                                    text: 'Jumlah Issues',
                                    font: {
                                        family: 'Inter',
                                        size: 11,
                                        weight: 'bold'
                                    },
                                    color: '#4b5563'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    font: {
                                        family: 'Inter',
                                        size: 11,
                                        weight: 'normal'
                                    },
                                    maxRotation: 0,
                                    minRotation: 0
                                },
                                title: {
                                    display: true,
                                    text: 'Rentang Aging',
                                    font: {
                                        family: 'Inter',
                                        size: 11,
                                        weight: 'bold'
                                    },
                                    color: '#4b5563'
                                }
                            }
                        }
                    }
                });
            }
        }

        function updateSummaryTables() {
            updateTopSitesTable();
            updateAgingIssuesTable();
            updateTopCategoriesTable();
            updateCircleSummaryTable();
            updateCitySummaryTable();
        }

        function updateTopSitesTable() {
            const tbody = document.getElementById('topSitesBody');
            
            if (filteredFsoData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-3">No FSO issues found</td></tr>';
                return;
            }
            
            // Group by site ID
            const siteStats = {};
            filteredFsoData.forEach(issue => {
                if (!siteStats[issue.siteId]) {
                    siteStats[issue.siteId] = {
                        siteId: issue.siteId,
                        total: 0,
                        open: 0,
                        p1: 0
                    };
                }
                
                siteStats[issue.siteId].total++;
                if (OPEN_STATUSES.includes(issue.status)) siteStats[issue.siteId].open++;
                if (issue.priority === 'P1') siteStats[issue.siteId].p1++;
            });
            
            // Convert to array and sort by total issues
            const sortedSites = Object.values(siteStats)
                .sort((a, b) => b.total - a.total)
                .slice(0, 10);
            
            tbody.innerHTML = '';
            
            if (sortedSites.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-3">No site data available</td></tr>';
                return;
            }
            
            sortedSites.forEach(site => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="site-id-cell">${site.siteId}</td>
                    <td class="text-end fw-semibold">${site.total}</td>
                    <td class="text-end">${site.open}</td>
                    <td class="text-end">${site.p1}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateAgingIssuesTable() {
            const tbody = document.getElementById('agingIssuesBody');
            
            if (filteredFsoData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-3">No FSO issues found</td></tr>';
                return;
            }
            
            // Filter open issues and sort by aging (descending)
            const agingIssues = filteredFsoData
                .filter(issue => OPEN_STATUSES.includes(issue.status))
                .sort((a, b) => b.aging - a.aging)
                .slice(0, 10);
            
            tbody.innerHTML = '';
            
            if (agingIssues.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-3">No open FSO issues</td></tr>';
                return;
            }
            
            agingIssues.forEach(issue => {
                const agingBadgeClass = issue.aging > 60 ? 'badge-aging-high' : 
                                       issue.aging > 30 ? 'badge-aging-medium' : 'badge-aging-low';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="site-id-cell">${issue.siteId}</td>
                    <td class="text-truncate-cell" title="${issue.problemCategory}">${issue.problemCategory}</td>
                    <td class="text-end">
                        <span class="badge ${agingBadgeClass}">${issue.aging} days</span>
                    </td>
                    <td><span class="badge badge-status-Open">${issue.status}</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateTopCategoriesTable() {
            const tbody = document.getElementById('topCategoriesBody');
            
            if (filteredFsoData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center py-3">No FSO issues found</td></tr>';
                return;
            }
            
            // Group by problem category
            const categoryStats = {};
            filteredFsoData.forEach(issue => {
                const category = issue.problemCategory || 'Unknown';
                if (!categoryStats[category]) {
                    categoryStats[category] = {
                        category: category,
                        total: 0
                    };
                }
                categoryStats[category].total++;
            });
            
            // Convert to array, calculate percentage, and sort by total issues
            const totalIssues = filteredFsoData.length;
            const categoryArray = Object.values(categoryStats)
                .map(cat => ({
                    ...cat,
                    percentage: ((cat.total / totalIssues) * 100).toFixed(1)
                }))
                .sort((a, b) => b.total - a.total)
                .slice(0, 5);
            
            tbody.innerHTML = '';
            
            categoryArray.forEach(cat => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${cat.category}</td>
                    <td class="text-end fw-semibold">${cat.total}</td>
                    <td class="text-end">${cat.percentage}%</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateCircleSummaryTable() {
            const tbody = document.getElementById('circleSummaryBody');
            
            if (filteredFsoData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-3">No FSO issues found</td></tr>';
                return;
            }
            
            // Group by circle
            const circleStats = {};
            filteredFsoData.forEach(issue => {
                const circle = issue.circle || 'Unknown';
                if (!circleStats[circle]) {
                    circleStats[circle] = {
                        circle: circle,
                        total: 0,
                        open: 0,
                        p1: 0,
                        totalAging: 0,
                        openCount: 0,
                        sites: new Set()
                    };
                }
                
                circleStats[circle].total++;
                if (OPEN_STATUSES.includes(issue.status)) {
                    circleStats[circle].open++;
                    circleStats[circle].totalAging += issue.aging;
                    circleStats[circle].openCount++;
                }
                if (issue.priority === 'P1') circleStats[circle].p1++;
                circleStats[circle].sites.add(issue.siteId);
            });
            
            // Calculate metrics and convert to array
            const circleArray = Object.values(circleStats).map(circle => ({
                ...circle,
                avgAging: circle.openCount > 0 ? Math.round(circle.totalAging / circle.openCount) : 0,
                uniqueSites: circle.sites.size,
                closedRate: circle.total > 0 ? Math.round(((circle.total - circle.open) / circle.total) * 100) : 0
            })).sort((a, b) => b.total - a.total);
            
            tbody.innerHTML = '';
            
            circleArray.forEach(circle => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${circle.circle}</strong></td>
                    <td class="text-end">${circle.total}</td>
                    <td class="text-end">
                        ${circle.open}
                        <span class="stats-badge ${circle.open > 0 ? 'stats-badge-danger' : 'stats-badge-success'}">
                            ${Math.round((circle.open / circle.total) * 100)}%
                        </span>
                    </td>
                    <td class="text-end">
                        ${circle.p1}
                        <span class="stats-badge ${circle.p1 > 0 ? 'stats-badge-warning' : 'stats-badge-success'}">
                            ${Math.round((circle.p1 / circle.total) * 100)}%
                        </span>
                    </td>
                    <td class="text-end">
                        ${circle.avgAging}d
                        <span class="stats-badge ${circle.avgAging > 30 ? 'stats-badge-danger' : circle.avgAging > 15 ? 'stats-badge-warning' : 'stats-badge-success'}">
                            ${circle.avgAging > 30 ? 'High' : circle.avgAging > 15 ? 'Medium' : 'Low'}
                        </span>
                    </td>
                    <td class="text-end">${circle.uniqueSites}</td>
                    <td class="text-end">
                        ${circle.closedRate}%
                        <span class="stats-badge ${circle.closedRate > 80 ? 'stats-badge-success' : circle.closedRate > 50 ? 'stats-badge-warning' : 'stats-badge-danger'}">
                            ${circle.closedRate > 80 ? 'Good' : circle.closedRate > 50 ? 'Fair' : 'Poor'}
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateCitySummaryTable() {
            const tbody = document.getElementById('citySummaryBody');
            
            if (filteredFsoData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center py-3">No FSO issues found</td></tr>';
                return;
            }
            
            // Group by city and area
            const cityStats = {};
            filteredFsoData.forEach(issue => {
                const city = issue.city || 'Unknown';
                const area = issue.area || 'Unknown';
                const key = city + '|' + area;
                
                if (!cityStats[key]) {
                    cityStats[key] = {
                        city: city,
                        area: area,
                        total: 0,
                        open: 0,
                        p1: 0,
                        totalAging: 0,
                        openCount: 0,
                        sites: new Set()
                    };
                }
                
                cityStats[key].total++;
                if (OPEN_STATUSES.includes(issue.status)) {
                    cityStats[key].open++;
                    cityStats[key].totalAging += issue.aging;
                    cityStats[key].openCount++;
                }
                if (issue.priority === 'P1') cityStats[key].p1++;
                cityStats[key].sites.add(issue.siteId);
            });
            
            // Calculate metrics and convert to array
            const cityArray = Object.values(cityStats).map(city => ({
                ...city,
                avgAging: city.openCount > 0 ? Math.round(city.totalAging / city.openCount) : 0,
                uniqueSites: city.sites.size,
                closedRate: city.total > 0 ? Math.round(((city.total - city.open) / city.total) * 100) : 0
            })).sort((a, b) => b.total - a.total);
            
            tbody.innerHTML = '';
            
            cityArray.forEach(city => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${city.city}</strong></td>
                    <td>${city.area}</td>
                    <td class="text-end">${city.total}</td>
                    <td class="text-end">
                        ${city.open}
                        <span class="stats-badge ${city.open > 0 ? 'stats-badge-danger' : 'stats-badge-success'}">
                            ${Math.round((city.open / city.total) * 100)}%
                        </span>
                    </td>
                    <td class="text-end">
                        ${city.p1}
                        <span class="stats-badge ${city.p1 > 0 ? 'stats-badge-warning' : 'stats-badge-success'}">
                            ${Math.round((city.p1 / city.total) * 100)}%
                        </span>
                    </td>
                    <td class="text-end">
                        ${city.avgAging}d
                        <span class="stats-badge ${city.avgAging > 30 ? 'stats-badge-danger' : city.avgAging > 15 ? 'stats-badge-warning' : 'stats-badge-success'}">
                            ${city.avgAging > 30 ? 'High' : city.avgAging > 15 ? 'Medium' : 'Low'}
                        </span>
                    </td>
                    <td class="text-end">${city.uniqueSites}</td>
                    <td class="text-end">
                        ${city.closedRate}%
                        <span class="stats-badge ${city.closedRate > 80 ? 'stats-badge-success' : city.closedRate > 50 ? 'stats-badge-warning' : 'stats-badge-danger'}">
                            ${city.closedRate > 80 ? 'Good' : city.closedRate > 50 ? 'Fair' : 'Poor'}
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateDetailedIssuesTable() {
            const tbody = document.getElementById('detailedIssuesTableBody');
            const countBadge = document.getElementById('tableCountBadge');
            
            if (filteredFsoData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="12" class="text-center py-5">
                            <i class="fas fa-search fa-2x text-muted mb-3"></i><br>
                            No FSO issues found matching your criteria
                        </td>
                    </tr>
                `;
                countBadge.textContent = 'Showing 0 issues';
                return;
            }
            
            let sortedData = [...filteredFsoData];
            
            // Apply sorting
            sortedData.sort((a, b) => {
                const aVal = a[currentSort.column];
                const bVal = b[currentSort.column];
                
                if (currentSort.column === 'aging') {
                    return currentSort.direction === 'asc' ? aVal - bVal : bVal - aVal;
                }
                
                if (typeof aVal === 'string' && typeof bVal === 'string') {
                    return currentSort.direction === 'asc'
                        ? aVal.localeCompare(bVal)
                        : bVal.localeCompare(aVal);
                }
                
                return 0;
            });
            
            tbody.innerHTML = '';
            
            sortedData.forEach(issue => {
                const agingBadgeClass = issue.aging > 60 ? 'badge-aging-high' : 
                                       issue.aging > 30 ? 'badge-aging-medium' : 'badge-aging-low';
                
                // Determine aging indicator
                let agingIndicator = '';
                if (issue.aging > 60) {
                    agingIndicator = '<span class="aging-indicator aging-critical" title="Critical: >60 days"></span>';
                } else if (issue.aging > 30) {
                    agingIndicator = '<span class="aging-indicator aging-warning" title="Warning: 30-60 days"></span>';
                } else {
                    agingIndicator = '<span class="aging-indicator aging-normal" title="Normal: 30 days"></span>';
                }
                
                // Truncate long text
                const truncatedAction = issue.action && issue.action.length > 50 ? 
                    issue.action.substring(0, 47) + '...' : (issue.action || '');
                
                const truncatedRootCause = issue.rootCause && issue.rootCause.length > 40 ? 
                    issue.rootCause.substring(0, 37) + '...' : (issue.rootCause || '');
                
                // Vendor logo
                const vendorLogoClass = issue.vendor.toLowerCase().includes('nokia') ? 'vendor-nokia' :
                                      issue.vendor.toLowerCase().includes('huawei') ? 'vendor-huawei' : 'vendor-other';
                const vendorInitial = issue.vendor ? issue.vendor.charAt(0).toUpperCase() : '?';
                
                // Determine status badge class
                const statusClass = OPEN_STATUSES.includes(issue.status) ? 'badge-status-Open' : 'badge-status-Closed';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="site-id-cell">${issue.siteId}</td>
                    <td title="${issue.problemCategory}">${issue.problemCategory}</td>
                    <td><span class="badge badge-priority-${issue.priority}">${issue.priority}</span></td>
                    <td><span class="badge ${statusClass}">${issue.status}</span></td>
                    <td>
                        ${agingIndicator}
                        <span class="badge ${agingBadgeClass}">${issue.aging}d</span>
                    </td>
                    <td class="text-truncate-cell tooltip-cell" title="${issue.rootCause}">${truncatedRootCause}</td>
                    <td class="text-truncate-cell tooltip-cell" title="${issue.action}">${truncatedAction}</td>
                    <td>${issue.circle || ''}</td>
                    <td>
                        <span class="vendor-logo ${vendorLogoClass}">${vendorInitial}</span>
                        ${issue.vendor || ''}
                    </td>
                    <td>${issue.city || ''}</td>
                    <td>${issue.area || ''}</td>
                    <td>${issue.openDate || ''}</td>
                `;
                tbody.appendChild(row);
            });
            
            countBadge.textContent = `Showing ${filteredFsoData.length} FSO issues`;
        }

        function sortTable(column) {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'desc';
            }
            
            updateDetailedIssuesTable();
        }

        // ==================== FUNGSI UTILITAS ====================
        function exportToCSV() {
            if (filteredFsoData.length === 0) {
                alert('No FSO data to export!');
                return;
            }
            
            const headers = ['SITE ID', 'Problem Category', 'Priority', 'Status', 'Aging', 'PIC', 
                           'Root Cause Category', 'Action Performed', 'Circle', 'Vendor', 'City', 'Area IOH', 'Open Date', 'Closed Date'];
            
            const csvData = [
                headers.join(','),
                ...filteredFsoData.map(issue => [
                    issue.siteId,
                    `"${(issue.problemCategory || '').replace(/"/g, '""')}"`,
                    issue.priority,
                    issue.status,
                    issue.aging,
                    issue.pic,
                    `"${(issue.rootCause || '').replace(/"/g, '""')}"`,
                    `"${(issue.action || '').replace(/"/g, '""')}"`,
                    issue.circle || '',
                    issue.vendor || '',
                    `"${(issue.city || '').replace(/"/g, '""')}"`,
                    `"${(issue.area || '').replace(/"/g, '""')}"`,
                    issue.openDate || '',
                    issue.closedDate || ''
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `fso_issues_${new Date().toISOString().slice(0,10)}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`Exported ${filteredFsoData.length} FSO issues to CSV`);
        }

        function updateCurrentTime() {
            const now = new Date();
            const options = { 
                weekday: 'short', 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit',
                hour12: false
            };
            document.getElementById('currentTime').textContent = 
                now.toLocaleDateString('en-GB', options).replace(',', '');
        }

        function updateLastUpdatedTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-GB', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            document.getElementById('lastUpdatedTime').textContent = timeString;
        }

        function updateDashboardStatus(status, message) {
            const badge = document.getElementById('dashboardStatus');
            
            switch(status) {
                case 'loading':
                    badge.className = 'badge bg-warning';
                    badge.innerHTML = '<i class="fas fa-sync fa-spin me-1"></i> ' + message;
                    break;
                case 'success':
                    badge.className = 'badge bg-success';
                    badge.innerHTML = '<i class="fas fa-check-circle me-1"></i> ' + message;
                    break;
                case 'error':
                    badge.className = 'badge bg-danger';
                    badge.innerHTML = '<i class="fas fa-exclamation-circle me-1"></i> ' + message;
                    break;
            }
        }

        function showLoading(show) {
            const loadingDiv = document.getElementById('loadingSpinner');
            if (loadingDiv) {
                loadingDiv.style.display = show ? 'flex' : 'none';
            }
        }

        function setupAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            autoRefreshInterval = setInterval(() => {
                if (isAutoRefresh) {
                    console.log('Auto-refreshing FSO data...');
                    fetchCSVData();
                }
            }, AUTO_REFRESH_INTERVAL);
        }

        function toggleAutoRefresh() {
            isAutoRefresh = !isAutoRefresh;
            const toggleButton = document.getElementById('autoRefreshToggle');
            const statusSpan = document.getElementById('autoRefreshStatus');
            
            if (isAutoRefresh) {
                setupAutoRefresh();
                statusSpan.textContent = 'ON';
                toggleButton.classList.remove('btn-outline-danger');
                toggleButton.classList.add('btn-outline-success');
                console.log('Auto-refresh enabled');
            } else {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
                statusSpan.textContent = 'OFF';
                toggleButton.classList.remove('btn-outline-success');
                toggleButton.classList.add('btn-outline-danger');
                console.log('Auto-refresh disabled');
            }
        }

        // ==================== TROUBLESHOOTING FUNCTIONS ====================
        function testCSVConnection() {
            console.log('Testing CSV connection for FSO...');
            fetch(CSV_URL)
                .then(response => {
                    console.log('Response status:', response.status);
                    return response.text();
                })
                .then(data => {
                    console.log('First 500 chars of response:', data.substring(0, 500));
                    alert('CSV connection successful! Check console for details.');
                })
                .catch(error => {
                    console.error('CSV connection failed:', error);
                    alert('CSV connection failed. Check console for error details.');
                });
        }
    </script>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
