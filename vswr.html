<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VSWR Issue Dashboard</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- PapaParse untuk parsing CSV -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js Data Labels Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0/dist/chartjs-plugin-datalabels.min.js"></script>

    <style>
        :root {
            --font-plus-jakarta: 'Plus Jakarta Sans', sans-serif;
            --font-inter: 'Inter', sans-serif;
            --critical-red: #dc3545;
            --warning-orange: #fd7e14;
            --normal-green: #28a745;
            --info-blue: #17a2b8;
            --vip-gold: #ffc107;
        }
        
        body {
            background: #f8fafc;
            font-family: var(--font-inter);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* HEADER */
        .executive-header {
            background: linear-gradient(135deg, #1a2980, #26d0ce);
            color: white;
            padding: 16px 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .executive-header h1 {
            font-family: var(--font-plus-jakarta);
            font-weight: 700;
            font-size: 1.5rem !important;
            margin: 0;
        }
        
        .executive-header p {
            font-family: var(--font-inter);
            font-weight: 400;
            font-size: 14px;
            opacity: 0.9;
        }
        
        /* FILTER INDICATOR */
        .filter-indicator {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            border-radius: 8px;
            padding: 8px 16px;
            margin-bottom: 20px;
            display: inline-block;
            font-weight: 600;
        }
        
        .filter-indicator i {
            margin-right: 8px;
        }
        
        /* KPI CARDS */
        .kpi-card {
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,.08);
            transition: all 0.3s ease;
            border: none;
            overflow: hidden;
            height: 100%;
        }
        
        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,.15);
        }
        
        .kpi-value {
            font-family: var(--font-plus-jakarta);
            font-weight: 800;
            font-size: 1.75rem;
            color: #1e293b;
        }
        
        .card-title {
            font-family: var(--font-plus-jakarta);
            font-weight: 600;
            font-size: 14px;
            color: #4b5563;
        }
        
        /* FILTER CARDS */
        .filter-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            border: none;
        }
        
        /* BUTTONS */
        .btn {
            font-family: var(--font-plus-jakarta);
            font-weight: 600;
            font-size: 14px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border: none;
            border-radius: 10px;
            padding: 10px;
        }
        
        .btn-outline-success {
            border-radius: 10px;
            padding: 10px 20px;
        }
        
        /* TABLE STYLING */
        .table thead th {
            font-family: var(--font-plus-jakarta);
            font-weight: 600;
            font-size: 12px;
            background: linear-gradient(135deg, #1e293b, #334155);
            color: #fff;
            position: sticky;
            top: 0;
            z-index: 10;
            border: none;
            padding: 8px 6px;
        }
        
        .table tbody td {
            font-family: var(--font-inter);
            font-weight: 400;
            font-size: 11px;
            padding: 6px 4px;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: middle;
        }
        
        /* BADGES */
        .badge {
            font-family: var(--font-plus-jakarta);
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
        }
        
        .badge-priority-P1 {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            border: none;
        }
        
        .badge-priority-P2 {
            background: linear-gradient(135deg, #fd7e14, #e8590c);
            color: white;
            border: none;
        }
        
        .badge-status-Open {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }
        
        .badge-status-Closed {
            background: linear-gradient(135deg, #28a745, #1e7e34);
            color: white;
        }
        
        /* AGING BADGES */
        .badge-aging-high {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }
        
        .badge-aging-medium {
            background: linear-gradient(135deg, #fd7e14, #e8590c);
            color: white;
        }
        
        .badge-aging-low {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
        }
        
        /* CHARTS CONTAINER */
        .chart-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            padding: 1rem;
            height: 100%;
        }
        
        /* MAIN TABLE CONTAINER */
        .main-table-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            border: none;
            overflow: hidden;
            flex: 1;
            height: 600px;
            display: flex;
            flex-direction: column;
            display: none; /* Hidden by default */
        }
        
        .main-table-wrapper {
            overflow: auto;
            flex: 1;
        }
        
        /* SITE ID CELL */
        .site-id-cell {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
            font-weight: 600;
            color: #1e40af;
            font-size: 11px;
        }
        
        /* LOADING */
        #loadingSpinner {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 60px;
            font-size: 18px;
            color: #64748b;
            font-family: var(--font-inter);
        }
        
        /* SEARCH HIGHLIGHT */
        .search-highlight {
            background-color: #fff3cd;
            font-weight: 600;
        }
        
        /* PROGRESS BARS */
        .progress {
            height: 6px;
            border-radius: 4px;
        }
        
        /* RESPONSIVE */
        @media (max-width: 768px) {
            .executive-header {
                padding: 12px 16px;
                text-align: center;
            }
            
            .executive-header h1 {
                font-size: 1.2rem !important;
            }
            
            .kpi-value {
                font-size: 1.5rem;
            }
        }
        
        /* CUSTOM SCROLLBAR */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* FORM CONTROLS */
        .form-control, .form-select {
            font-family: var(--font-inter);
            font-size: 12px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        /* INFO BADGES */
        .info-badge {
            font-family: var(--font-inter);
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 10px;
            background: #e2e8f0;
            color: #475569;
        }
        
        /* TRUNCATE TEXT */
        .text-truncate-cell {
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* AGING INDICATOR */
        .aging-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        
        .aging-critical { background-color: #dc3545; }
        .aging-warning { background-color: #fd7e14; }
        .aging-normal { background-color: #28a745; }
        
        /* TOOLTIP */
        .tooltip-cell {
            cursor: help;
            border-bottom: 1px dotted #666;
        }
        
        /* SUMMARY SECTIONS */
        .summary-section {
            margin-bottom: 1.5rem;
        }
        
        .summary-section h6 {
            color: #1e293b;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        
        /* HIDDEN DETAILS */
        .hidden-details {
            display: none;
        }
        
        /* SEARCH RESULT INFO */
        .search-result-info {
            background: #f1f5f9;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid #3b82f6;
        }
        
        /* STATS BADGE */
        .stats-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-weight: 600;
        }
        
        .stats-badge-primary { background: #dbeafe; color: #1d4ed8; }
        .stats-badge-success { background: #dcfce7; color: #166534; }
        .stats-badge-warning { background: #fef3c7; color: #92400e; }
        .stats-badge-danger { background: #fee2e2; color: #991b1b; }
        
        /* VENDOR LOGO */
        .vendor-logo {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            margin-right: 5px;
        }
        
        .vendor-nokia { background: #142c8e; color: white; }
        .vendor-huawei { background: #d4001a; color: white; }
        .vendor-other { background: #6b7280; color: white; }
        
        /* CHART TITLE */
        .chart-title {
            font-family: var(--font-plus-jakarta);
            font-weight: 600;
            font-size: 14px !important;
            margin-bottom: 16px;
            color: #1e293b;
        }
        
        .chart-title i {
            margin-right: 8px;
            color: #3b82f6;
        }
        
        /* DASHBOARD TITLE */
        .dashboard-title {
            font-family: var(--font-plus-jakarta);
            font-weight: 700;
            font-size: 24px;
            color: #1e293b;
            margin-bottom: 20px;
            padding-left: 12px;
            border-left: 4px solid #3b82f6;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="executive-header">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="mb-1"><i class="fas fa-tasks me-2"></i>VSWR Issue Dashboard</h1>
                    <p class="small mb-0 opacity-75">Real-time Monitoring for VSWR Problems</p>
                </div>
                <div class="text-end">
                    <div class="small mb-1"><i class="fas fa-clock me-1"></i> <span id="currentTime">Loading...</span></div>
                    <span class="badge bg-danger" id="dashboardStatus">
                        <i class="fas fa-circle me-1"></i> Loading VSWR Data...
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container-fluid py-4">
        <!-- Filter Indicator -->
        <div class="filter-indicator">
            <i class="fas fa-filter"></i> Active Filter: <strong>Problem Category = VSWR</strong>
            <span class="ms-3 badge bg-white text-dark" id="vswrCountBadge">Loading...</span>
        </div>
        
        <!-- Dashboard Title -->
        <div class="dashboard-title">
            <i class="fas fa-chart-line me-2"></i>VSWR Issues Overview
        </div>
        
        <!-- KPI Summary Row (dengan UNIQUE SITES menggantikan AVG AGING) -->
        <div class="row mb-4">
            <!-- TOTAL VSWR -->
            <div class="col-xl-2 col-lg-4 col-md-6 mb-3">
                <div class="card kpi-card p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title">TOTAL VSWR</h6>
                            <div class="kpi-value text-primary" id="kpiTotalIssues">0</div>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-tasks fa-2x text-primary opacity-50"></i>
                        </div>
                    </div>
                    <div class="small text-muted mt-2">All VSWR issues</div>
                </div>
            </div>
            <!-- UNIQUE SITES (NEW CARD) -->
            <div class="col-xl-2 col-lg-4 col-md-6 mb-3">
                <div class="card kpi-card p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title">UNIQUE SITES</h6>
                            <div class="kpi-value text-secondary" id="kpiUniqueSites">0</div>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-map-marker-alt fa-2x text-secondary opacity-50"></i>
                        </div>
                    </div>
                    <div class="small text-muted mt-2">Distinct site locations</div>
                </div>
            </div>
            <!-- OPEN VSWR -->
            <div class="col-xl-2 col-lg-4 col-md-6 mb-3">
                <div class="card kpi-card p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title">OPEN VSWR</h6>
                            <div class="kpi-value text-danger" id="kpiOpenIssues">0</div>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-exclamation-circle fa-2x text-danger opacity-50"></i>
                        </div>
                    </div>
                    <div class="small text-muted mt-2">VSWR issues pending</div>
                </div>
            </div>
            <!-- CLOSED VSWR -->
            <div class="col-xl-2 col-lg-4 col-md-6 mb-3">
                <div class="card kpi-card p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title">CLOSED VSWR</h6>
                            <div class="kpi-value text-success" id="kpiClosedIssues">0</div>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-check-circle fa-2x text-success opacity-50"></i>
                        </div>
                    </div>
                    <div class="small text-muted mt-2">Resolved VSWR issues</div>
                </div>
            </div>
            <!-- HIGH PRIORITY -->
            <div class="col-xl-2 col-lg-4 col-md-6 mb-3">
                <div class="card kpi-card p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title">HIGH PRIORITY</h6>
                            <div class="kpi-value text-warning" id="kpiHighPriority">0</div>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-flag fa-2x text-warning opacity-50"></i>
                        </div>
                    </div>
                    <div class="small text-muted mt-2">P1 VSWR issues</div>
                </div>
            </div>
            <!-- AGING > 1 MONTH -->
            <div class="col-xl-2 col-lg-4 col-md-6 mb-3">
                <div class="card kpi-card p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title">AGING > 1 MONTH</h6>
                            <div class="kpi-value text-info" id="kpiAgingIssues">0</div>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-calendar-times fa-2x text-info opacity-50"></i>
                        </div>
                    </div>
                    <div class="small text-muted mt-2">VSWR >30 days old</div>
                </div>
            </div>
        </div>

        <!-- Filter and Search Row -->
        <div class="row mb-4">
            <div class="col-lg-12">
                <div class="card filter-card">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-id-badge"></i></span>
                                    <input type="text" class="form-control" id="searchSiteId" placeholder="Search Site ID" onkeyup="applyFilters()">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-exclamation-circle"></i></span>
                                    <select class="form-select" id="filterStatus" onchange="applyFilters()">
                                        <option value="">All Status</option>
                                        <option value="Open">Open</option>
                                        <option value="Closed">Closed</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-flag"></i></span>
                                    <select class="form-select" id="filterPriority" onchange="applyFilters()">
                                        <option value="">All Priority</option>
                                        <option value="P1">P1</option>
                                        <option value="P2">P2</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                                    <select class="form-select" id="filterCircle" onchange="applyFilters()">
                                        <option value="">All Circles</option>
                                        <!-- Options will be populated dynamically -->
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-3">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-chart-bar"></i></span>
                                    <select class="form-select" id="filterCategory" onchange="applyFilters()">
                                        <option value="">All Categories</option>
                                        <!-- Options will be populated dynamically (will only show VSWR) -->
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-user"></i></span>
                                    <select class="form-select" id="filterPIC" onchange="applyFilters()">
                                        <option value="">All PIC</option>
                                        <!-- Options will be populated dynamically -->
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                                    <i class="fas fa-eraser me-1"></i> Clear All Filters
                                </button>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="search-result-info" id="searchResultInfo" style="display: none;">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-1" id="searchResultTitle">Search Results</h6>
                                            <small class="text-muted" id="searchResultText"></small>
                                        </div>
                                        <div>
                                            <button class="btn btn-primary btn-sm" onclick="showDetailedTable()">
                                                <i class="fas fa-table me-1"></i> Show Details
                                            </button>
                                            <button class="btn btn-outline-success btn-sm ms-2" onclick="exportToCSV()">
                                                <i class="fas fa-download me-1"></i> Export
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 1 -->
        <div class="row mb-4">
            <div class="col-lg-4 mb-4">
                <div class="chart-container">
                    <h6 class="chart-title"><i class="fas fa-chart-pie"></i>VSWR Status Distribution</h6>
                    <div style="height: 250px; position: relative;">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 mb-4">
                <div class="chart-container">
                    <h6 class="chart-title"><i class="fas fa-chart-bar"></i>VSWR Priority Distribution</h6>
                    <div style="height: 250px; position: relative;">
                        <canvas id="priorityChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 mb-4">
                <div class="chart-container">
                    <h6 class="chart-title"><i class="fas fa-chart-line"></i>VSWR by Circle</h6>
                    <div style="height: 250px; position: relative;">
                        <canvas id="circleChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 2 -->
        <div class="row mb-4">
            <div class="col-lg-4 mb-4">
                <div class="chart-container">
                    <h6 class="chart-title"><i class="fas fa-industry"></i>VSWR by Vendor</h6>
                    <div style="height: 250px; position: relative;">
                        <canvas id="vendorChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 mb-4">
                <div class="chart-container">
                    <h6 class="chart-title"><i class="fas fa-user"></i>VSWR by PIC</h6>
                    <div style="height: 250px; position: relative;">
                        <canvas id="picChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 mb-4">
                <div class="chart-container">
                    <h6 class="chart-title"><i class="fas fa-calendar-alt"></i>Aging Distribution</h6>
                    <div style="height: 250px; position: relative;">
                        <canvas id="agingChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Tables -->
        <div class="row mb-4">
            <!-- Top Sites with VSWR Issues -->
            <div class="col-lg-4 mb-4">
                <div class="chart-container">
                    <h6 class="chart-title"><i class="fas fa-building"></i>Top Sites with VSWR Issues</h6>
                    <div class="table-responsive" style="max-height: 300px;">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Site ID</th>
                                    <th class="text-end">Issues</th>
                                    <th class="text-end">Open</th>
                                    <th class="text-end">P1</th>
                                </tr>
                            </thead>
                            <tbody id="topSitesBody">
                                <tr><td colspan="4" class="text-center py-3">Loading VSWR data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Aging Analysis for VSWR -->
            <div class="col-lg-4 mb-4">
                <div class="chart-container">
                    <h6 class="chart-title"><i class="fas fa-calendar-alt"></i>Oldest Open VSWR Issues</h6>
                    <div class="table-responsive" style="max-height: 300px;">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Site ID</th>
                                    <th>Issue</th>
                                    <th class="text-end">Aging</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="agingIssuesBody">
                                <tr><td colspan="4" class="text-center py-3">Loading VSWR data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Vendor Performance for VSWR -->
            <div class="col-lg-4 mb-4">
                <div class="chart-container">
                    <h6 class="chart-title"><i class="fas fa-industry"></i>Vendor Performance</h6>
                    <div class="table-responsive" style="max-height: 300px;">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Vendor</th>
                                    <th class="text-end">Issues</th>
                                    <th class="text-end">Open</th>
                                    <th class="text-end">Avg Aging</th>
                                </tr>
                            </thead>
                            <tbody id="vendorPerformanceBody">
                                <tr><td colspan="4" class="text-center py-3">Loading VSWR data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Circle Summary for VSWR -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="chart-container">
                    <h6 class="chart-title"><i class="fas fa-map-marked-alt"></i>Circle Performance Summary</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Circle</th>
                                    <th class="text-end">Total Issues</th>
                                    <th class="text-end">Open Issues</th>
                                    <th class="text-end">P1 Issues</th>
                                    <th class="text-end">Avg Aging</th>
                                    <th class="text-end">Unique Sites</th>
                                    <th class="text-end">Closed Rate</th>
                                </tr>
                            </thead>
                            <tbody id="circleSummaryBody">
                                <tr><td colspan="7" class="text-center py-3">Loading VSWR data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed VSWR Issues Table (Hidden by default) -->
        <div class="row">
            <div class="col-12">
                <div class="main-table-container" id="detailedTableContainer">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0" style="font-family: var(--font-plus-jakarta); font-weight: 700; font-size: 14px;">
                            <i class="fas fa-table me-2"></i>Detailed VSWR Issues
                        </h6>
                        <div>
                            <span class="info-badge me-2" id="tableCountBadge">Showing 0 issues</span>
                            <button class="btn btn-outline-secondary btn-sm" onclick="hideDetailedTable()">
                                <i class="fas fa-times me-1"></i> Hide
                            </button>
                            <button class="btn btn-outline-success btn-sm ms-2" onclick="exportToCSV()">
                                <i class="fas fa-download me-1"></i> Export
                            </button>
                        </div>
                    </div>
                    <div class="main-table-wrapper">
                        <div class="table-responsive" id="issuesTableContainer">
                            <table class="table table-striped table-hover table-sm">
                                <thead>
                                    <tr>
                                        <th class="cursor-pointer" onclick="sortTable('siteId')">
                                            Site ID <i class="fas fa-sort ms-1"></i>
                                        </th>
                                        <th class="cursor-pointer" onclick="sortTable('problemCategory')">
                                            Problem <i class="fas fa-sort ms-1"></i>
                                        </th>
                                        <th class="cursor-pointer" onclick="sortTable('priority')">
                                            Priority <i class="fas fa-sort ms-1"></i>
                                        </th>
                                        <th class="cursor-pointer" onclick="sortTable('status')">
                                            Status <i class="fas fa-sort ms-1"></i>
                                        </th>
                                        <th class="cursor-pointer" onclick="sortTable('aging')">
                                            Aging <i class="fas fa-sort ms-1"></i>
                                        </th>
                                        <th class="cursor-pointer" onclick="sortTable('pic')">
                                            PIC <i class="fas fa-sort ms-1"></i>
                                        </th>
                                        <th class="cursor-pointer" onclick="sortTable('rootCause')">
                                            Root Cause <i class="fas fa-sort ms-1"></i>
                                        </th>
                                        <th class="cursor-pointer" onclick="sortTable('action')">
                                            Action <i class="fas fa-sort ms-1"></i>
                                        </th>
                                        <th>Circle</th>
                                        <th>Vendor</th>
                                    </tr>
                                </thead>
                                <tbody id="detailedIssuesTableBody">
                                    <!-- Data akan diisi oleh JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="text-center small text-muted">
                    <p class="mb-1" style="font-family: var(--font-inter);">
                        <i class="fas fa-database me-1"></i> Data Source: Google Sheets | 
                        <i class="fas fa-filter me-1 ms-3"></i> Filter: VSWR Only |
                        <i class="fas fa-clock me-1 ms-3"></i> Last Updated: <span id="lastUpdatedTime">-</span> |
                        <i class="fas fa-info-circle me-1 ms-3"></i> Total VSWR Records: <span id="totalRecords">0</span>
                    </p>
                    <p class="mb-0" style="font-family: var(--font-inter);">
                        <button class="btn btn-link btn-sm text-decoration-none" onclick="fetchCSVData()">
                            <i class="fas fa-redo me-1"></i> Refresh VSWR Data
                        </button>
                        <button class="btn btn-link btn-sm text-decoration-none" onclick="toggleAutoRefresh()" id="autoRefreshToggle">
                            <i class="fas fa-sync me-1"></i> Auto-Refresh: <span id="autoRefreshStatus">ON</span>
                        </button>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Register the plugin
        Chart.register(ChartDataLabels);
        
        // ==================== KONFIGURASI ====================
        const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSchfOZU-jK0FoiBjpyWsAezO2MdnPkJUh5bKRbs1sAI6DpJ0DocsMNBL_89QMjnnho1X9x_bKwEqjD/pub?gid=0&single=true&output=csv";

        // ==================== VARIABEL GLOBAL ====================
        let allVswrData = [];
        let filteredVswrData = [];
        let currentSort = { column: 'aging', direction: 'desc' };
        let statusChart, priorityChart, circleChart, vendorChart, picChart, agingChart;
        let autoRefreshInterval = null;
        let isAutoRefresh = true;
        const AUTO_REFRESH_INTERVAL = 30000; // 30 detik
        const VSWR_CATEGORY = "VSWR";

        // ==================== FUNGSI INISIALISASI ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('VSWR Dashboard initializing...');
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            // Setup auto-refresh
            setupAutoRefresh();
            
            // Load data
            fetchCSVData();
        });

        // ==================== FUNGSI DATA ====================
        function fetchCSVData() {
            console.log('Fetching CSV data for VSWR from:', CSV_URL);
            showLoading(true);
            updateDashboardStatus('loading', 'Fetching VSWR data...');
            
            Papa.parse(CSV_URL, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    console.log('CSV parsing complete. Total rows:', results.data.length);
                    
                    if (results.data && results.data.length > 0) {
                        processVswrData(results.data);
                        debugData();
                        updateDashboardStatus('success', `VSWR data loaded (${allVswrData.length} records)`);
                    } else {
                        console.warn('No data found in CSV');
                        showError('No data found in the CSV file.');
                        updateDashboardStatus('error', 'No data found');
                    }
                    showLoading(false);
                    updateLastUpdatedTime();
                    
                    // Update VSWR count badge
                    document.getElementById('vswrCountBadge').textContent = `${allVswrData.length} VSWR Issues`;
                    
                    // Hide search result info and detailed table initially
                    document.getElementById('searchResultInfo').style.display = 'none';
                    document.getElementById('detailedTableContainer').style.display = 'none';
                },
                error: function(error) {
                    console.error('Error fetching CSV:', error);
                    showError('Failed to load data from CSV. Please check the URL or internet connection.');
                    updateDashboardStatus('error', 'Failed to load data');
                    showLoading(false);
                }
            });
        }

        function processVswrData(rawData) {
            allVswrData = [];
            const circles = new Set();
            const problemCategories = new Set();
            const vendors = new Set();
            const pics = new Set();
            
            rawData.forEach(row => {
                try {
                    // Check if this is a VSWR issue
                    const problemCategory = (row['Problem Category'] || row['problemCategory'] || '').toString().trim().toUpperCase();
                    
                    // Only include VSWR issues
                    if (problemCategory !== VSWR_CATEGORY) return;
                    
                    const siteId = row['SITE ID'] || row['siteId'] || row['Site ID'] || '';
                    const priority = row['Priority'] || row['priority'] || 'P2';
                    const status = row['Status(1)'] || row['Status'] || row['status'] || 'Open';
                    const aging = parseInt(row['Aging']) || parseInt(row['aging']) || 0;
                    const pic = row['PIC'] || row['pic'] || '';
                    const rootCause = row['Root Cause Category'] || row['rootCause'] || '';
                    const action = row['Action Performed'] || row['action'] || '';
                    const circle = row['Circle'] || row['circle'] || '';
                    const vendor = row['Vendor'] || row['vendor'] || '';
                    const openDate = row['Open Date'] || '';
                    const closedDate = row['Closed Date'] || '';
                    const city = row['City'] || '';
                    
                    if (!siteId) return;
                    
                    // Clean and normalize data
                    const cleanStatus = String(status).trim();
                    const cleanPriority = String(priority).trim().toUpperCase();
                    const cleanCircle = String(circle).trim();
                    const cleanVendor = String(vendor).trim();
                    const cleanCategory = String(problemCategory).trim();
                    const cleanPic = String(pic).trim();
                    
                    // Add to sets for filters
                    if (cleanCircle) circles.add(cleanCircle);
                    if (cleanCategory) problemCategories.add(cleanCategory);
                    if (cleanVendor) vendors.add(cleanVendor);
                    if (cleanPic) pics.add(cleanPic);
                    
                    const processedRow = {
                        raw: row,
                        siteId: siteId,
                        problemCategory: cleanCategory,
                        priority: cleanPriority === 'P1' ? 'P1' : 'P2',
                        status: cleanStatus === 'Closed' ? 'Closed' : 'Open',
                        aging: aging,
                        pic: cleanPic,
                        rootCause: rootCause,
                        action: action,
                        circle: cleanCircle,
                        vendor: cleanVendor,
                        openDate: openDate,
                        closedDate: closedDate,
                        city: city,
                        isHighAging: aging > 30,
                        isCritical: aging > 60
                    };
                    
                    allVswrData.push(processedRow);
                } catch (error) {
                    console.warn('Error processing VSWR row:', error);
                }
            });
            
            console.log(`Filtered to ${allVswrData.length} VSWR issue records`);
            
            // Update filter options (only VSWR categories)
            updateFilterOptions('filterCircle', Array.from(circles));
            updateFilterOptions('filterCategory', Array.from(problemCategories)); // Will only show VSWR
            updateFilterOptions('filterPIC', Array.from(pics).sort());
            
            // Vendor filter not in original, but we'll keep it simple
            // If needed, add vendor filter select to HTML
            
            applyFilters();
        }

        function updateFilterOptions(selectId, options) {
            const filterSelect = document.getElementById(selectId);
            if (!filterSelect) return;
            
            // Set placeholder text based on selectId
            let placeholderText = "All";
            if (selectId === 'filterCircle') placeholderText = "All Circles";
            else if (selectId === 'filterCategory') placeholderText = "All Categories";
            else if (selectId === 'filterPIC') placeholderText = "All PIC";
            else if (selectId === 'filterStatus') placeholderText = "All Status";
            else if (selectId === 'filterPriority') placeholderText = "All Priority";
            
            filterSelect.innerHTML = `<option value="">${placeholderText}</option>`;
            
            Array.from(options).sort().forEach(option => {
                if (option && option.trim()) {
                    const opt = document.createElement('option');
                    opt.value = option;
                    opt.textContent = option;
                    filterSelect.appendChild(opt);
                }
            });
        }

        function debugData() {
            console.log('=== VSWR DATA DEBUG ===');
            console.log('Total VSWR records:', allVswrData.length);
            if (allVswrData.length > 0) {
                console.log('Sample VSWR records (first 3):', allVswrData.slice(0, 3));
                console.log('Status distribution:', {
                    Open: allVswrData.filter(d => d.status === 'Open').length,
                    Closed: allVswrData.filter(d => d.status === 'Closed').length
                });
                console.log('Priority distribution:', {
                    P1: allVswrData.filter(d => d.priority === 'P1').length,
                    P2: allVswrData.filter(d => d.priority === 'P2').length
                });
                console.log('All circles:', [...new Set(allVswrData.map(d => d.circle))]);
                console.log('All vendors:', [...new Set(allVswrData.map(d => d.vendor))]);
                console.log('All PICs:', [...new Set(allVswrData.map(d => d.pic))].filter(pic => pic));
            }
            console.log('=== END VSWR DEBUG ===');
        }

        // ==================== FUNGSI FILTER & PENCARIAN ====================
        function applyFilters() {
            const searchSiteId = document.getElementById('searchSiteId').value.toLowerCase().trim();
            const filterStatus = document.getElementById('filterStatus').value;
            const filterPriority = document.getElementById('filterPriority').value;
            const filterCircle = document.getElementById('filterCircle').value;
            const filterCategory = document.getElementById('filterCategory').value;
            const filterPIC = document.getElementById('filterPIC').value;
            
            filteredVswrData = allVswrData.filter(issue => {
                const siteIdMatch = !searchSiteId || 
                    issue.siteId.toLowerCase().includes(searchSiteId);
                
                const statusMatch = !filterStatus || 
                    issue.status === filterStatus;
                
                const priorityMatch = !filterPriority || 
                    issue.priority === filterPriority;
                
                const circleMatch = !filterCircle || 
                    issue.circle === filterCircle;
                
                const categoryMatch = !filterCategory || 
                    issue.problemCategory === filterCategory;
                
                const picMatch = !filterPIC || 
                    issue.pic === filterPIC;
                
                return siteIdMatch && statusMatch && priorityMatch && circleMatch && categoryMatch && picMatch;
            });
            
            updateSummaryKPIs();
            updateCharts();
            updateSummaryTables();
            updateSearchResultInfo();
        }

        function updateSearchResultInfo() {
            const searchResultInfo = document.getElementById('searchResultInfo');
            const searchResultText = document.getElementById('searchResultText');
            const searchResultTitle = document.getElementById('searchResultTitle');
            
            const searchSiteId = document.getElementById('searchSiteId').value;
            const filterStatus = document.getElementById('filterStatus').value;
            const filterPriority = document.getElementById('filterPriority').value;
            const filterCircle = document.getElementById('filterCircle').value;
            const filterCategory = document.getElementById('filterCategory').value;
            const filterPIC = document.getElementById('filterPIC').value;
            
            // Build search description
            let searchDescription = [];
            if (searchSiteId) searchDescription.push(`Site ID: "${searchSiteId}"`);
            if (filterStatus) searchDescription.push(`Status: ${filterStatus}`);
            if (filterPriority) searchDescription.push(`Priority: ${filterPriority}`);
            if (filterCircle) searchDescription.push(`Circle: ${filterCircle}`);
            if (filterCategory) searchDescription.push(`Category: ${filterCategory}`);
            if (filterPIC) searchDescription.push(`PIC: ${filterPIC}`);
            
            if (searchDescription.length > 0) {
                searchResultTitle.textContent = `VSWR Search Results (${filteredVswrData.length} issues found)`;
                searchResultText.textContent = `Filters applied: ${searchDescription.join(', ')}`;
                searchResultInfo.style.display = 'block';
                
                // Hide detailed table if showing
                document.getElementById('detailedTableContainer').style.display = 'none';
            } else {
                searchResultInfo.style.display = 'none';
            }
        }

        function clearFilters() {
            document.getElementById('searchSiteId').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterPriority').value = '';
            document.getElementById('filterCircle').value = '';
            document.getElementById('filterCategory').value = '';
            document.getElementById('filterPIC').value = '';
            
            applyFilters();
        }

        function showDetailedTable() {
            document.getElementById('detailedTableContainer').style.display = 'flex';
            updateDetailedIssuesTable();
            
            // Scroll to the table
            document.getElementById('detailedTableContainer').scrollIntoView({ 
                behavior: 'smooth' 
            });
        }

        function hideDetailedTable() {
            document.getElementById('detailedTableContainer').style.display = 'none';
        }

        // ==================== FUNGSI UPDATE UI ====================
        function updateSummaryKPIs() {
            const totalIssues = allVswrData.length;
            
            // Calculate unique sites
            const uniqueSites = new Set(allVswrData.map(issue => issue.siteId)).size;
            
            const openIssues = allVswrData.filter(issue => issue.status === 'Open').length;
            const closedIssues = allVswrData.filter(issue => issue.status === 'Closed').length;
            const highPriorityIssues = allVswrData.filter(issue => issue.priority === 'P1').length;
            const agingIssues = allVswrData.filter(issue => issue.aging > 30).length;
            
            document.getElementById('kpiTotalIssues').textContent = totalIssues.toLocaleString();
            document.getElementById('kpiUniqueSites').textContent = uniqueSites.toLocaleString();
            document.getElementById('kpiOpenIssues').textContent = openIssues.toLocaleString();
            document.getElementById('kpiClosedIssues').textContent = closedIssues.toLocaleString();
            document.getElementById('kpiHighPriority').textContent = highPriorityIssues.toLocaleString();
            document.getElementById('kpiAgingIssues').textContent = agingIssues.toLocaleString();
            
            // Update total records
            document.getElementById('totalRecords').textContent = totalIssues;
        }

        function updateCharts() {
            // Update Status Chart - DENGAN DATA LABEL WARNA PUTIH
            const statusCounts = {
                'Open': filteredVswrData.filter(issue => issue.status === 'Open').length,
                'Closed': filteredVswrData.filter(issue => issue.status === 'Closed').length
            };
            
            if (statusChart) statusChart.destroy();
            const statusCtx = document.getElementById('statusChart');
            if (statusCtx) {
                statusChart = new Chart(statusCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Open', 'Closed'],
                        datasets: [{
                            data: [statusCounts.Open, statusCounts.Closed],
                            backgroundColor: ['#dc3545', '#28a745'],
                            borderWidth: 1,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '65%',
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    font: {
                                        family: 'Inter',
                                        size: 10
                                    }
                                }
                            },
                            datalabels: {
                                display: true,
                                color: '#ffffff',
                                font: {
                                    family: 'Inter',
                                    weight: 'bold',
                                    size: 12
                                },
                                formatter: (value, context) => {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${percentage}%`;
                                },
                                anchor: 'center',
                                align: 'center',
                                offset: 0
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Update Priority Chart
            const priorityCounts = {
                'P1': filteredVswrData.filter(issue => issue.priority === 'P1').length,
                'P2': filteredVswrData.filter(issue => issue.priority === 'P2').length
            };
            
            if (priorityChart) priorityChart.destroy();
            const priorityCtx = document.getElementById('priorityChart');
            if (priorityCtx) {
                const maxValue = Math.max(priorityCounts.P1, priorityCounts.P2);
                const yAxisMax = Math.ceil(maxValue * 1.2);
                
                priorityChart = new Chart(priorityCtx, {
                    type: 'bar',
                    data: {
                        labels: ['P1 (High)', 'P2 (Normal)'],
                        datasets: [{
                            label: 'VSWR Issues',
                            data: [priorityCounts.P1, priorityCounts.P2],
                            backgroundColor: ['#fd7e14', '#6c757d'],
                            borderWidth: 0,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            datalabels: {
                                display: true,
                                color: '#000000',
                                font: {
                                    family: 'Inter',
                                    weight: 'bold',
                                    size: 12
                                },
                                formatter: (value) => {
                                    return value;
                                },
                                anchor: 'end',
                                align: 'top',
                                offset: 4
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: yAxisMax,
                                ticks: {
                                    font: {
                                        family: 'Inter',
                                        size: 10
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    font: {
                                        family: 'Inter',
                                        size: 11
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Update Circle Chart - DENGAN DATA LABEL WARNA PUTIH
            const circleCounts = {};
            filteredVswrData.forEach(issue => {
                const circle = issue.circle || 'Unknown';
                circleCounts[circle] = (circleCounts[circle] || 0) + 1;
            });
            
            const sortedCircles = Object.entries(circleCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            if (circleChart) circleChart.destroy();
            const circleCtx = document.getElementById('circleChart');
            if (circleCtx) {
                circleChart = new Chart(circleCtx, {
                    type: 'pie',
                    data: {
                        labels: sortedCircles.map(item => item[0]),
                        datasets: [{
                            data: sortedCircles.map(item => item[1]),
                            backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    font: {
                                        family: 'Inter',
                                        size: 9
                                    },
                                    generateLabels: function(chart) {
                                        const data = chart.data;
                                        if (data.labels.length && data.datasets.length) {
                                            const dataset = data.datasets[0];
                                            return data.labels.map((label, i) => {
                                                const value = dataset.data[i];
                                                const total = dataset.data.reduce((a, b) => a + b, 0);
                                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                                return {
                                                    text: `${label}: ${value} (${percentage}%)`,
                                                    fillStyle: dataset.backgroundColor[i],
                                                    hidden: false,
                                                    index: i
                                                };
                                            });
                                        }
                                        return [];
                                    }
                                }
                            },
                            datalabels: {
                                display: true,
                                color: '#ffffff',
                                font: {
                                    family: 'Inter',
                                    weight: 'bold',
                                    size: 11
                                },
                                formatter: (value, context) => {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${percentage}%`;
                                },
                                anchor: 'center',
                                align: 'center',
                                offset: 0
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Update Vendor Chart
            const vendorCounts = {};
            filteredVswrData.forEach(issue => {
                const vendor = issue.vendor || 'Unknown';
                vendorCounts[vendor] = (vendorCounts[vendor] || 0) + 1;
            });
            
            const sortedVendors = Object.entries(vendorCounts)
                .sort((a, b) => b[1] - a[1]);
            
            if (vendorChart) vendorChart.destroy();
            const vendorCtx = document.getElementById('vendorChart');
            if (vendorCtx) {
                vendorChart = new Chart(vendorCtx, {
                    type: 'bar',
                    data: {
                        labels: sortedVendors.map(item => item[0]),
                        datasets: [{
                            label: 'VSWR Issues',
                            data: sortedVendors.map(item => item[1]),
                            backgroundColor: sortedVendors.map(item => 
                                item[0].toLowerCase().includes('nokia') ? '#142c8e' :
                                item[0].toLowerCase().includes('huawei') ? '#d4001a' :
                                '#6b7280'
                            ),
                            borderWidth: 0,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            datalabels: {
                                display: true,
                                color: '#000000',
                                font: {
                                    family: 'Inter',
                                    weight: 'bold',
                                    size: 11
                                },
                                formatter: (value) => {
                                    return value;
                                },
                                anchor: 'end',
                                align: 'top',
                                offset: 4
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    font: {
                                        family: 'Inter',
                                        size: 10
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    font: {
                                        family: 'Inter',
                                        size: 10
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Update PIC Chart - DENGAN DATA LABEL WARNA PUTIH
            const picCounts = {};
            filteredVswrData.forEach(issue => {
                const pic = issue.pic || 'Unassigned';
                picCounts[pic] = (picCounts[pic] || 0) + 1;
            });
            
            const sortedPICs = Object.entries(picCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            if (picChart) picChart.destroy();
            const picCtx = document.getElementById('picChart');
            if (picCtx) {
                picChart = new Chart(picCtx, {
                    type: 'pie',
                    data: {
                        labels: sortedPICs.map(item => item[0]),
                        datasets: [{
                            data: sortedPICs.map(item => item[1]),
                            backgroundColor: ['#9b59b6', '#3498db', '#e67e22', '#2ecc71', '#e74c3c'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: {
                            padding: {
                                top: 20,
                                bottom: 20
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    font: {
                                        family: 'Inter',
                                        size: 9
                                    },
                                    generateLabels: function(chart) {
                                        const data = chart.data;
                                        if (data.labels.length && data.datasets.length) {
                                            const dataset = data.datasets[0];
                                            return data.labels.map((label, i) => {
                                                const value = dataset.data[i];
                                                const total = dataset.data.reduce((a, b) => a + b, 0);
                                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                                return {
                                                    text: `${label}: ${value} (${percentage}%)`,
                                                    fillStyle: dataset.backgroundColor[i],
                                                    hidden: false,
                                                    index: i
                                                };
                                            });
                                        }
                                        return [];
                                    }
                                }
                            },
                            datalabels: {
                                display: true,
                                color: '#ffffff',
                                font: {
                                    family: 'Inter',
                                    weight: 'bold',
                                    size: 11
                                },
                                formatter: (value, context) => {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${percentage}%`;
                                },
                                anchor: function(context) {
                                    const index = context.dataIndex;
                                    const anchors = ['end', 'center', 'start', 'center', 'end'];
                                    return anchors[index % anchors.length] || 'center';
                                },
                                align: function(context) {
                                    const index = context.dataIndex;
                                    const aligns = ['start', 'center', 'end', 'center', 'start'];
                                    return aligns[index % aligns.length] || 'center';
                                },
                                offset: 8,
                                clamp: true,
                                overlap: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Update Aging Distribution Chart
            const agingRanges = {
                '0-7 days': filteredVswrData.filter(issue => issue.aging <= 7).length,
                '8-14 days': filteredVswrData.filter(issue => issue.aging > 7 && issue.aging <= 14).length,
                '15-30 days': filteredVswrData.filter(issue => issue.aging > 14 && issue.aging <= 30).length,
                '31-60 days': filteredVswrData.filter(issue => issue.aging > 30 && issue.aging <= 60).length,
                '>60 days': filteredVswrData.filter(issue => issue.aging > 60).length
            };
            
            if (agingChart) agingChart.destroy();
            const agingCtx = document.getElementById('agingChart');
            if (agingCtx) {
                agingChart = new Chart(agingCtx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(agingRanges),
                        datasets: [{
                            label: 'VSWR Issues',
                            data: Object.values(agingRanges),
                            backgroundColor: ['#28a745', '#17a2b8', '#ffc107', '#fd7e14', '#dc3545'],
                            borderWidth: 0,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            datalabels: {
                                display: true,
                                color: '#000000',
                                font: {
                                    family: 'Inter',
                                    weight: 'bold',
                                    size: 11
                                },
                                formatter: (value) => {
                                    return value;
                                },
                                anchor: 'end',
                                align: 'top',
                                offset: 4
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    font: {
                                        family: 'Inter',
                                        size: 10
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    font: {
                                        family: 'Inter',
                                        size: 9,
                                        maxRotation: 45,
                                        minRotation: 45
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        function updateSummaryTables() {
            updateTopSitesTable();
            updateAgingIssuesTable();
            updateVendorPerformanceTable();
            updateCircleSummaryTable();
        }

        function updateTopSitesTable() {
            const tbody = document.getElementById('topSitesBody');
            
            if (filteredVswrData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-3">No VSWR issues found</td></tr>';
                return;
            }
            
            // Group by site ID
            const siteStats = {};
            filteredVswrData.forEach(issue => {
                if (!siteStats[issue.siteId]) {
                    siteStats[issue.siteId] = {
                        siteId: issue.siteId,
                        total: 0,
                        open: 0,
                        p1: 0
                    };
                }
                
                siteStats[issue.siteId].total++;
                if (issue.status === 'Open') siteStats[issue.siteId].open++;
                if (issue.priority === 'P1') siteStats[issue.siteId].p1++;
            });
            
            // Convert to array and sort by total issues
            const sortedSites = Object.values(siteStats)
                .sort((a, b) => b.total - a.total)
                .slice(0, 10);
            
            tbody.innerHTML = '';
            
            if (sortedSites.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-3">No site data available</td></tr>';
                return;
            }
            
            sortedSites.forEach(site => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="site-id-cell">${site.siteId}</td>
                    <td class="text-end fw-semibold">${site.total}</td>
                    <td class="text-end">${site.open}</td>
                    <td class="text-end">${site.p1}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateAgingIssuesTable() {
            const tbody = document.getElementById('agingIssuesBody');
            
            if (filteredVswrData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-3">No VSWR issues found</td></tr>';
                return;
            }
            
            // Filter open issues and sort by aging (descending)
            const agingIssues = filteredVswrData
                .filter(issue => issue.status === 'Open')
                .sort((a, b) => b.aging - a.aging)
                .slice(0, 10);
            
            tbody.innerHTML = '';
            
            if (agingIssues.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-3">No open VSWR issues</td></tr>';
                return;
            }
            
            agingIssues.forEach(issue => {
                const agingBadgeClass = issue.aging > 60 ? 'badge-aging-high' : 
                                       issue.aging > 30 ? 'badge-aging-medium' : 'badge-aging-low';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="site-id-cell">${issue.siteId}</td>
                    <td class="text-truncate-cell" title="${issue.problemCategory}">${issue.problemCategory}</td>
                    <td class="text-end">
                        <span class="badge ${agingBadgeClass}">${issue.aging} days</span>
                    </td>
                    <td><span class="badge badge-status-Open">${issue.status}</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateVendorPerformanceTable() {
            const tbody = document.getElementById('vendorPerformanceBody');
            
            if (filteredVswrData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-3">No VSWR issues found</td></tr>';
                return;
            }
            
            // Group by vendor
            const vendorStats = {};
            filteredVswrData.forEach(issue => {
                const vendor = issue.vendor || 'Unknown';
                if (!vendorStats[vendor]) {
                    vendorStats[vendor] = {
                        vendor: vendor,
                        total: 0,
                        open: 0,
                        totalAging: 0,
                        count: 0
                    };
                }
                
                vendorStats[vendor].total++;
                if (issue.status === 'Open') vendorStats[vendor].open++;
                if (issue.status === 'Open') {
                    vendorStats[vendor].totalAging += issue.aging;
                    vendorStats[vendor].count++;
                }
            });
            
            // Calculate averages and convert to array
            const vendorArray = Object.values(vendorStats).map(vendor => ({
                ...vendor,
                avgAging: vendor.count > 0 ? Math.round(vendor.totalAging / vendor.count) : 0
            })).sort((a, b) => b.total - a.total);
            
            tbody.innerHTML = '';
            
            vendorArray.forEach(vendor => {
                const vendorLogoClass = vendor.vendor.toLowerCase().includes('nokia') ? 'vendor-nokia' :
                                      vendor.vendor.toLowerCase().includes('huawei') ? 'vendor-huawei' : 'vendor-other';
                const vendorInitial = vendor.vendor.charAt(0).toUpperCase();
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <span class="vendor-logo ${vendorLogoClass}">${vendorInitial}</span>
                        ${vendor.vendor}
                    </td>
                    <td class="text-end fw-semibold">${vendor.total}</td>
                    <td class="text-end">${vendor.open}</td>
                    <td class="text-end">${vendor.avgAging}d</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateCircleSummaryTable() {
            const tbody = document.getElementById('circleSummaryBody');
            
            if (filteredVswrData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-3">No VSWR issues found</td></tr>';
                return;
            }
            
            // Group by circle
            const circleStats = {};
            filteredVswrData.forEach(issue => {
                const circle = issue.circle || 'Unknown';
                if (!circleStats[circle]) {
                    circleStats[circle] = {
                        circle: circle,
                        total: 0,
                        open: 0,
                        p1: 0,
                        totalAging: 0,
                        openCount: 0,
                        sites: new Set()
                    };
                }
                
                circleStats[circle].total++;
                if (issue.status === 'Open') {
                    circleStats[circle].open++;
                    circleStats[circle].totalAging += issue.aging;
                    circleStats[circle].openCount++;
                }
                if (issue.priority === 'P1') circleStats[circle].p1++;
                circleStats[circle].sites.add(issue.siteId);
            });
            
            // Calculate metrics and convert to array
            const circleArray = Object.values(circleStats).map(circle => ({
                ...circle,
                avgAging: circle.openCount > 0 ? Math.round(circle.totalAging / circle.openCount) : 0,
                uniqueSites: circle.sites.size,
                closedRate: circle.total > 0 ? Math.round(((circle.total - circle.open) / circle.total) * 100) : 0
            })).sort((a, b) => b.total - a.total);
            
            tbody.innerHTML = '';
            
            circleArray.forEach(circle => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${circle.circle}</strong></td>
                    <td class="text-end">${circle.total}</td>
                    <td class="text-end">
                        ${circle.open}
                        <span class="stats-badge ${circle.open > 0 ? 'stats-badge-danger' : 'stats-badge-success'}">
                            ${Math.round((circle.open / circle.total) * 100)}%
                        </span>
                    </td>
                    <td class="text-end">
                        ${circle.p1}
                        <span class="stats-badge ${circle.p1 > 0 ? 'stats-badge-warning' : 'stats-badge-success'}">
                            ${Math.round((circle.p1 / circle.total) * 100)}%
                        </span>
                    </td>
                    <td class="text-end">
                        ${circle.avgAging}d
                        <span class="stats-badge ${circle.avgAging > 30 ? 'stats-badge-danger' : circle.avgAging > 15 ? 'stats-badge-warning' : 'stats-badge-success'}">
                            ${circle.avgAging > 30 ? 'High' : circle.avgAging > 15 ? 'Medium' : 'Low'}
                        </span>
                    </td>
                    <td class="text-end">${circle.uniqueSites}</td>
                    <td class="text-end">
                        ${circle.closedRate}%
                        <span class="stats-badge ${circle.closedRate > 80 ? 'stats-badge-success' : circle.closedRate > 50 ? 'stats-badge-warning' : 'stats-badge-danger'}">
                            ${circle.closedRate > 80 ? 'Good' : circle.closedRate > 50 ? 'Fair' : 'Poor'}
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateDetailedIssuesTable() {
            const tbody = document.getElementById('detailedIssuesTableBody');
            const countBadge = document.getElementById('tableCountBadge');
            
            if (filteredVswrData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="text-center py-5">
                            <i class="fas fa-search fa-2x text-muted mb-3"></i><br>
                            No VSWR issues found matching your criteria
                        </td>
                    </tr>
                `;
                countBadge.textContent = 'Showing 0 issues';
                return;
            }
            
            let sortedData = [...filteredVswrData];
            
            // Apply sorting
            sortedData.sort((a, b) => {
                const aVal = a[currentSort.column];
                const bVal = b[currentSort.column];
                
                if (currentSort.column === 'aging') {
                    return currentSort.direction === 'asc' ? aVal - bVal : bVal - aVal;
                }
                
                if (typeof aVal === 'string' && typeof bVal === 'string') {
                    return currentSort.direction === 'asc'
                        ? aVal.localeCompare(bVal)
                        : bVal.localeCompare(aVal);
                }
                
                return 0;
            });
            
            tbody.innerHTML = '';
            
            sortedData.forEach(issue => {
                const agingBadgeClass = issue.aging > 60 ? 'badge-aging-high' : 
                                       issue.aging > 30 ? 'badge-aging-medium' : 'badge-aging-low';
                
                // Determine aging indicator
                let agingIndicator = '';
                if (issue.aging > 60) {
                    agingIndicator = '<span class="aging-indicator aging-critical" title="Critical: >60 days"></span>';
                } else if (issue.aging > 30) {
                    agingIndicator = '<span class="aging-indicator aging-warning" title="Warning: 30-60 days"></span>';
                } else {
                    agingIndicator = '<span class="aging-indicator aging-normal" title="Normal: 30 days"></span>';
                }
                
                // Truncate long text
                const truncatedAction = issue.action && issue.action.length > 50 ? 
                    issue.action.substring(0, 47) + '...' : (issue.action || '');
                
                const truncatedRootCause = issue.rootCause && issue.rootCause.length > 40 ? 
                    issue.rootCause.substring(0, 37) + '...' : (issue.rootCause || '');
                
                // Vendor logo
                const vendorLogoClass = issue.vendor.toLowerCase().includes('nokia') ? 'vendor-nokia' :
                                      issue.vendor.toLowerCase().includes('huawei') ? 'vendor-huawei' : 'vendor-other';
                const vendorInitial = issue.vendor ? issue.vendor.charAt(0).toUpperCase() : '?';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="site-id-cell">${issue.siteId}</td>
                    <td title="${issue.problemCategory}">${issue.problemCategory}</td>
                    <td><span class="badge badge-priority-${issue.priority}">${issue.priority}</span></td>
                    <td><span class="badge badge-status-${issue.status}">${issue.status}</span></td>
                    <td>
                        ${agingIndicator}
                        <span class="badge ${agingBadgeClass}">${issue.aging}d</span>
                    </td>
                    <td>${issue.pic || ''}</td>
                    <td class="text-truncate-cell tooltip-cell" title="${issue.rootCause}">${truncatedRootCause}</td>
                    <td class="text-truncate-cell tooltip-cell" title="${issue.action}">${truncatedAction}</td>
                    <td>${issue.circle || ''}</td>
                    <td>
                        <span class="vendor-logo ${vendorLogoClass}">${vendorInitial}</span>
                        ${issue.vendor || ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            countBadge.textContent = `Showing ${filteredVswrData.length} VSWR issues`;
        }

        function sortTable(column) {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'desc';
            }
            
            updateDetailedIssuesTable();
        }

        // ==================== FUNGSI UTILITAS ====================
        function exportToCSV() {
            if (filteredVswrData.length === 0) {
                alert('No VSWR data to export!');
                return;
            }
            
            const headers = ['SITE ID', 'Problem Category', 'Priority', 'Status', 'Aging', 'PIC', 
                           'Root Cause Category', 'Action Performed', 'Circle', 'Vendor', 'Open Date', 'Closed Date'];
            
            const csvData = [
                headers.join(','),
                ...filteredVswrData.map(issue => [
                    issue.siteId,
                    `"${(issue.problemCategory || '').replace(/"/g, '""')}"`,
                    issue.priority,
                    issue.status,
                    issue.aging,
                    `"${(issue.pic || '').replace(/"/g, '""')}"`,
                    `"${(issue.rootCause || '').replace(/"/g, '""')}"`,
                    `"${(issue.action || '').replace(/"/g, '""')}"`,
                    issue.circle || '',
                    issue.vendor || '',
                    issue.openDate || '',
                    issue.closedDate || ''
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `vswr_issues_${new Date().toISOString().slice(0,10)}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`Exported ${filteredVswrData.length} VSWR issues to CSV`);
        }

        function updateCurrentTime() {
            const now = new Date();
            const options = { 
                weekday: 'short', 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit',
                hour12: false
            };
            document.getElementById('currentTime').textContent = 
                now.toLocaleDateString('en-GB', options).replace(',', '');
        }

        function updateLastUpdatedTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-GB', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            document.getElementById('lastUpdatedTime').textContent = timeString;
        }

        function updateDashboardStatus(status, message) {
            const badge = document.getElementById('dashboardStatus');
            
            switch(status) {
                case 'loading':
                    badge.className = 'badge bg-warning';
                    badge.innerHTML = '<i class="fas fa-sync fa-spin me-1"></i> ' + message;
                    break;
                case 'success':
                    badge.className = 'badge bg-success';
                    badge.innerHTML = '<i class="fas fa-check-circle me-1"></i> ' + message;
                    break;
                case 'error':
                    badge.className = 'badge bg-danger';
                    badge.innerHTML = '<i class="fas fa-exclamation-circle me-1"></i> ' + message;
                    break;
            }
        }

        function showLoading(show) {
            const loadingDiv = document.getElementById('loadingSpinner');
            if (loadingDiv) {
                loadingDiv.style.display = show ? 'flex' : 'none';
            }
        }

        function setupAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            autoRefreshInterval = setInterval(() => {
                if (isAutoRefresh) {
                    console.log('Auto-refreshing VSWR data...');
                    fetchCSVData();
                }
            }, AUTO_REFRESH_INTERVAL);
        }

        function toggleAutoRefresh() {
            isAutoRefresh = !isAutoRefresh;
            const toggleButton = document.getElementById('autoRefreshToggle');
            const statusSpan = document.getElementById('autoRefreshStatus');
            
            if (isAutoRefresh) {
                setupAutoRefresh();
                statusSpan.textContent = 'ON';
                toggleButton.classList.remove('btn-outline-danger');
                toggleButton.classList.add('btn-outline-success');
                console.log('Auto-refresh enabled');
            } else {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
                statusSpan.textContent = 'OFF';
                toggleButton.classList.remove('btn-outline-success');
                toggleButton.classList.add('btn-outline-danger');
                console.log('Auto-refresh disabled');
            }
        }

        // ==================== TROUBLESHOOTING FUNCTIONS ====================
        function testCSVConnection() {
            console.log('Testing CSV connection for VSWR...');
            fetch(CSV_URL)
                .then(response => {
                    console.log('Response status:', response.status);
                    return response.text();
                })
                .then(data => {
                    console.log('First 500 chars of response:', data.substring(0, 500));
                    alert('CSV connection successful! Check console for details.');
                })
                .catch(error => {
                    console.error('CSV connection failed:', error);
                    alert('CSV connection failed. Check console for error details.');
                });
        }
    </script>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
